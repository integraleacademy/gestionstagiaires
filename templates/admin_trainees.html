{% extends "base.html" %}
{% block content %}

<div class="breadcrumbs">
  <a href="{{ url_for('admin_sessions', **request.args) }}">‚Üê Retour sessions</a>
</div>

<div class="session-header">
  <div>
    <h1>{{ session.name }}</h1>
    <div class="meta-line">
      <span class="pill">{{ session.training_type }}</span>
      <span>Formation : <strong>{{ session.date_start|frdate }}</strong> ‚Üí <strong>{{ session.date_end|frdate }}</strong></span>
      <span>Examen : <strong>{{ session.exam_date|frdate }}</strong></span>

    </div>
  </div>

  <div class="session-stats">
    <div class="stat">
      <div class="stat-title">Stagiaires</div>
      <div class="stat-value">{{ stats.total }}</div>
    </div>
    <div class="stat">
      <div class="stat-title">Conformes</div>
      <div class="stat-value">{{ stats.conform_count }}</div>
    </div>
    <div class="stat">
      <div class="stat-title">Non conformes</div>
      <div class="stat-value">{{ stats.non_conform_count }}</div>
    </div>
    <div class="stat">
      <div class="stat-title">Session</div>
      <div class="stat-value">{{ "Conforme ‚úÖ" if stats.session_is_conform else "Non conforme ‚ùå" }}</div>
    </div>
  </div>
</div>

<div class="page-head" style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;">
  <h2 style="margin:0;">Stagiaires</h2>

  <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
 <button class="btn btn-outline" id="btnBulkSst">‚¨áÔ∏è T√©l√©charger les SST en masse</button>
<input id="bulkSstInput" type="file" multiple accept=".pdf,.jpg,.jpeg,.png" style="display:none">


    <button class="btn btn-primary" id="btnOpenCreateTrainee">+ Ajouter un stagiaire</button>
  </div>
</div>

<div class="table-wrap full-bleed">
  <table class="table" id="traineesTable"
         data-session-id="{{ session.id }}"
         data-show-hosting="{{ '1' if show_hosting else '0' }}"
         data-show-vae="{{ '1' if show_vae else '0' }}">
    <thead>
      <tr>
        <th>Nom</th>
        <th>Pr√©nom</th>
        <th>Mail</th>
        <th>T√©l√©phone</th>

        <th>Convention</th>
        <th>Test Fran√ßais</th>
        <th>Dossier</th>
        <th>CNAPS</th>
        {% if show_hosting %}<th>H√©bergement</th>{% endif %}
        <th>Commentaire</th>
        {% if show_vae %}<th>VAE</th>{% endif %}
        <th>Financement</th>
        <th>Fiche</th>
        <th>Suppr.</th>
      </tr>
    </thead>

    <tbody>
      {% for t in trainees %}
      <tr class="row {% if t.comment %}row-warning{% endif %}" data-trainee-id="{{ t.id }}">
        <td>{{ t.last_name }}</td>
        <td>{{ t.first_name }}</td>
        <td class="mono">{{ t.email }}</td>
        <td class="mono">{{ t.phone }}</td>

        <td>
          <select class="status sel" data-field="convention_status">
            {% for v in enums.convention %}
              <option value="{{ v }}" {% if t.convention_status==v %}selected{% endif %}>
                {{ "PROCHAINEMENT" if v=="soon" else ("EN COURS DE SIGNATURE" if v=="signing" else "SIGN√âE") }}
              </option>
            {% endfor %}
          </select>
        </td>

<td>
  <select class="status sel" data-field="test_fr_status">
    <option value="soon" {% if t.test_fr_status=="soon" or not t.test_fr_status %}selected{% endif %}>PROCHAINEMENT</option>
    <option value="in_progress" {% if t.test_fr_status=="in_progress" %}selected{% endif %}>EN COURS</option>
    <option value="relance" {% if t.test_fr_status=="relance" %}selected{% endif %}>RELANC√â</option>
    <option value="validated" {% if t.test_fr_status=="validated" %}selected{% endif %}>VALID√â</option>
  </select>
</td>



        <td>
          <select class="status sel" data-field="dossier_status">
            <option value="complete" {% if t.dossier_status=="complete" %}selected{% endif %}>complet</option>
            <option value="incomplete" {% if t.dossier_status=="incomplete" %}selected{% endif %}>incomplet</option>
          </select>
        </td>

        <td>
          <div class="inline">
            <span class="cnaps" data-cnaps>{{ t.cnaps or "INCONNU" }}</span>
            <button class="mini-btn" data-refresh type="button">‚Üª</button>
          </div>
        </td>

        {% if show_hosting %}
        <td>
          <span class="hosting" data-hosting>
            {{ "r√©serv√©" if t.hosting_status=="reserved" else ("inconnu" if t.hosting_status=="unknown" else t.hosting_status) }}
          </span>
        </td>
        {% endif %}

        <td>
          <input class="comment" data-field="comment" value="{{ t.comment }}" placeholder="Ajouter un commentaire...">
        </td>

        {% if show_vae %}
        <td>
  <select class="status sel" data-field="vae_status">
    <option value="soon" {% if t.vae_status=="soon" or not t.vae_status %}selected{% endif %}>
      PROCHAINEMENT
    </option>
    <option value="in_progress" {% if t.vae_status=="in_progress" %}selected{% endif %}>
      EN COURS
    </option>
    <option value="validated" {% if t.vae_status=="validated" %}selected{% endif %}>
      VALID√â
    </option>
  </select>
</td>

        {% endif %}

        <td>
          <select class="status sel" data-field="financement_status">
            <option value="soon" {% if t.financement_status=="soon" %}selected{% endif %}>prochainement</option>
            <option value="in_review" {% if t.financement_status=="in_review" %}selected{% endif %}>en cours de validation</option>
            <option value="validated" {% if t.financement_status=="validated" %}selected{% endif %}>valid√©</option>
          </select>
        </td>

        <td>
          <a class="btn btn-outline"
             href="/admin/sessions/{{ session.id }}/stagiaires/{{ t.id }}"
             style="text-decoration:none;display:inline-block">
            Fiche
          </a>
          <div class="small mono">ID: {{ t.personal_id }}</div>
          {% if t.comment %}
            <div class="warn-line">‚ö†Ô∏è</div>
          {% endif %}
        </td>

        <td>
          <button class="btn btn-danger" data-delete-trainee type="button">üóëÔ∏è</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- MODALE CREATION STAGIAIRE -->
<div class="modal-backdrop" id="createTraineeModal" aria-hidden="true">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title">Ajouter un stagiaire</div>
      <button class="icon-btn" data-close-modal="createTraineeModal">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="form-grid">
        <label>
          <div class="label">Nom</div>
          <input id="tLastName" type="text" placeholder="Nom">
        </label>
        <label>
          <div class="label">Pr√©nom</div>
          <input id="tFirstName" type="text" placeholder="Pr√©nom">
        </label>
        <label>
          <div class="label">Adresse mail</div>
          <input id="tEmail" type="email" placeholder="email@exemple.com">
        </label>
        <label>
          <div class="label">T√©l√©phone</div>
          <input id="tPhone" type="tel" placeholder="+33600000000">
          <div class="hint">Format conseill√© : +33‚Ä¶</div>
        </label>
        <label style="display:flex;align-items:center;gap:10px;margin-top:8px;">
  <input id="tCarteProOk" type="checkbox" style="width:18px;height:18px;">
  <div class="label" style="margin:0;">Carte professionnelle (CNAPS) d√©j√† OK</div>
</label>

      </div>
    </div>

    <div class="modal-foot">
      <button class="btn" data-close-modal="createTraineeModal">Annuler</button>
      <button class="btn btn-primary" id="btnCreateTrainee">Sauvegarder</button>
    </div>
  </div>
</div>

<!-- MODALE CONFIRM ENVOI -->
<div class="modal-backdrop" id="sendAccessModal" aria-hidden="true">
  <div class="modal" style="max-width:520px">
    <div class="modal-head">
      <div class="modal-title">Envoyer l‚Äôacc√®s au stagiaire ?</div>
      <button class="icon-btn" data-close-modal="sendAccessModal">‚úï</button>
    </div>

    <div class="modal-body">
      <p style="margin:0 0 10px 0">
        Tu veux envoyer <strong>le mail + le SMS</strong> maintenant ?
      </p>
      <div class="hint" id="sendAccessPreview" style="margin-top:8px"></div>
    </div>

    <div class="modal-foot">
      <button class="btn" data-close-modal="sendAccessModal">Annuler</button>
      <button class="btn btn-outline" id="btnCreateNoSend">Cr√©er sans envoyer</button>
      <button class="btn btn-primary" id="btnCreateAndSend">Cr√©er + envoyer</button>
    </div>
  </div>
</div>

  <!-- MODALE RESULTAT IMPORT SST -->
<div class="modal-backdrop" id="bulkSstResultModal" aria-hidden="true">
  <div class="modal" style="max-width:640px">
    <div class="modal-head">
      <div class="modal-title">Import SST termin√©</div>
      <button class="icon-btn" data-close-modal="bulkSstResultModal">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="hint" id="bulkSstSummary" style="margin-bottom:10px;"></div>

      <div id="bulkSstFailuresWrap" style="display:none;">
        <div style="font-weight:900;margin-bottom:6px;">Fichiers non rattach√©s</div>
        <div class="hint" style="margin-bottom:8px;">
          (Nom/pr√©nom introuvables dans le fichier ou plusieurs correspondances)
        </div>
        <ul id="bulkSstFailures" style="margin:0;padding-left:18px;"></ul>
      </div>
    </div>

    <div class="modal-foot">
      <button class="btn" data-close-modal="bulkSstResultModal">OK</button>
    </div>
  </div>
</div>


<script>
  const sessionId = document.getElementById("traineesTable").getAttribute("data-session-id");

  document.querySelectorAll("[data-refresh]").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      e.preventDefault();

      const tr = btn.closest("tr");
      const traineeId = tr.getAttribute("data-trainee-id");

      const nom = tr.querySelector("td:nth-child(1)")?.textContent.trim() || "";
      const prenom = tr.querySelector("td:nth-child(2)")?.textContent.trim() || "";

      if (!traineeId || !nom || !prenom) {
        alert("Nom / pr√©nom introuvables");
        return;
      }

      btn.disabled = true;

      try {
        const res = await cnapsLookup(nom, prenom);
        const statut = (res.statut_cnaps || "INCONNU").toUpperCase();

        const span = tr.querySelector("[data-cnaps]");
        if (span){
          span.textContent = statut;
          applyCnapsBadge(span); // ‚úÖ recolor instant
        }

        await fetch(`/api/sessions/${sessionId}/stagiaires/${traineeId}/update`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ cnaps: statut })
        });

      } catch (err) {
        alert("Erreur CNAPS");
      } finally {
        btn.disabled = false;
      }
    });
  });

  // =========================
// Bulk SST upload
// =========================
const btnBulkSst = document.getElementById("btnBulkSst");
const bulkSstInput = document.getElementById("bulkSstInput");

btnBulkSst?.addEventListener("click", ()=>{
  bulkSstInput.value = "";
  bulkSstInput.click();
});

bulkSstInput?.addEventListener("change", async ()=>{
  const files = [...bulkSstInput.files || []];
  if(!files.length) return;

  // petit garde-fou
  const allowed = ["application/pdf","image/jpeg","image/png"];
  const bad = files.filter(f => !allowed.includes(f.type) && !f.name.toLowerCase().endsWith(".pdf"));
  if(bad.length){
    alert("Certains fichiers ne sont pas accept√©s (PDF/JPG/PNG).");
    return;
  }

  btnBulkSst.disabled = true;
  btnBulkSst.textContent = "Import en cours...";

  try{
    const fd = new FormData();
    files.forEach(f => fd.append("files", f));

    const r = await fetch(`/api/sessions/${sessionId}/sst/bulk_upload`, {
      method: "POST",
      body: fd
    });

    const res = await r.json();

    if(!r.ok || !res.ok){
      alert("Erreur import SST : " + (res.error || "unknown"));
      return;
    }

    // UI r√©sultat
    const summary = document.getElementById("bulkSstSummary");
    const wrap = document.getElementById("bulkSstFailuresWrap");
    const ul = document.getElementById("bulkSstFailures");

    const total = res.total || files.length;
    const added = res.added_count || 0;
    const failed = res.failed || [];

    if(summary){
      summary.innerHTML = `<strong>${added} fichiers ajout√©s</strong> sur <strong>${total}</strong> t√©l√©charg√©s.`;
    }

    if(ul) ul.innerHTML = "";
    if(failed.length){
      if(wrap) wrap.style.display = "block";
      failed.forEach(it=>{
        const li = document.createElement("li");
        li.textContent = `${it.filename}${it.reason ? " ‚Äî " + it.reason : ""}`;
        ul.appendChild(li);
      });
    }else{
      if(wrap) wrap.style.display = "none";
    }

    openModal("bulkSstResultModal");

    // refresh table (pour voir le SST import√© sur les fiches si tu affiches un indicateur)
    // window.location.reload();

  }catch(e){
    alert("Erreur r√©seau pendant l'import SST");
  }finally{
    btnBulkSst.disabled = false;
    btnBulkSst.textContent = "‚¨áÔ∏è T√©l√©charger les SST en masse";
  }
});


  // =========================
  // UI: colors for status selects + CNAPS + Hosting
  // =========================
  function toClassSafe(s){
    return (s || "").toString().trim().toLowerCase().replace(/\s+/g,"_");
  }

  function applyStatusPill(selectEl){
    if(!selectEl) return;
    selectEl.classList.add("status-pill");

    [...selectEl.classList].forEach(c=>{
      if(c.startsWith("is-")) selectEl.classList.remove(c);
    });

    const v = toClassSafe(selectEl.value);
    if(v) selectEl.classList.add("is-" + v);
    else selectEl.classList.add("is-soon");
  }

  function cnapsClassFromText(txt){
    const t = (txt || "").toString().trim().toUpperCase();
    if(t.includes("TRANSM")) return "cnaps-transmis";
    if(t.includes("ENREG"))  return "cnaps-enregistre";
    if(t.includes("INSTRU")) return "cnaps-instruction";
    if(t.includes("ACCEPT")) return "cnaps-accepte";
    if(t.includes("REFUS"))  return "cnaps-refuse";
    if(t.includes("DOC"))    return "cnaps-docs";
    if(t.includes("CARTE PROFESSIONNELLE OK")) return "cnaps-accepte";
    return "cnaps-inconnu";
  }

  function applyCnapsBadge(span){
    if(!span) return;
    span.classList.add("cnaps");
    [...span.classList].forEach(c=>{
      if(c.startsWith("cnaps-")) span.classList.remove(c);
    });
    span.classList.add(cnapsClassFromText(span.textContent));
  }

  function applyHostingBadge(span){
    if(!span) return;
    span.classList.add("status-pill");
    [...span.classList].forEach(c=>{
      if(c.startsWith("is-")) span.classList.remove(c);
    });

    const v = toClassSafe(span.textContent);
    if(v.includes("reserved") || v.includes("r√©serv")) span.classList.add("is-reserved");
    else span.classList.add("is-unknown");
  }

  function applyAllColors(){
    document.querySelectorAll("select.sel").forEach(sel => applyStatusPill(sel));
    document.querySelectorAll("[data-cnaps]").forEach(span => applyCnapsBadge(span));
    document.querySelectorAll("[data-hosting]").forEach(span => applyHostingBadge(span));
  }

  // ‚úÖ applique les couleurs au chargement
  applyAllColors();

  // =========================
  // modal open
  // =========================
  document.getElementById("btnOpenCreateTrainee")?.addEventListener("click", ()=>{
    openModal("createTraineeModal");
  });

  // =========================
  // create trainee
  // =========================

  // --- helper : lire le formulaire une seule fois ---
  function readCreateForm(){
    const last_name = (document.getElementById("tLastName").value || "").trim();
    const first_name = (document.getElementById("tFirstName").value || "").trim();
    const email = (document.getElementById("tEmail").value || "").trim();
    const phone = (document.getElementById("tPhone").value || "").trim();
    const carte_pro_ok = !!document.getElementById("tCarteProOk")?.checked;
    return { last_name, first_name, email, phone, carte_pro_ok };
  }

  function setCreateButtonsDisabled(disabled){
    const b1 = document.getElementById("btnCreateTrainee");
    const b2 = document.getElementById("btnCreateNoSend");
    const b3 = document.getElementById("btnCreateAndSend");
    if(b1) b1.disabled = disabled;
    if(b2) b2.disabled = disabled;
    if(b3) b3.disabled = disabled;
  }

  async function createTrainee(send_access){
    const { last_name, first_name, email, phone, carte_pro_ok } = readCreateForm();

    if(!last_name || !first_name){
      alert("Nom + pr√©nom obligatoires");
      return;
    }

    setCreateButtonsDisabled(true);

    try{
      const r = await fetch(`/api/sessions/${sessionId}/trainees/create`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ last_name, first_name, email, phone, carte_pro_ok, send_access })
      });

      const res = await r.json();
      if(!r.ok || !res.ok){
        alert("Erreur ajout stagiaire");
        return;
      }

      window.location.reload();
    }catch(e){
      alert("Erreur r√©seau");
    }finally{
      setCreateButtonsDisabled(false);
    }
  }

  // ‚úÖ 1) clic sur "Sauvegarder" => ouvre la modale de choix
  document.getElementById("btnCreateTrainee")?.addEventListener("click", ()=>{
    const { last_name, first_name, email, phone } = readCreateForm();

    if(!last_name || !first_name){
      alert("Nom + pr√©nom obligatoires");
      return;
    }

    const preview = document.getElementById("sendAccessPreview");
    if(preview){
      const parts = [];
      if(email) parts.push(`üìß ${email}`);
      if(phone) parts.push(`üì± ${phone}`);
      preview.textContent = parts.length ? ("Destinataire : " + parts.join("  ‚Ä¢  ")) : "Aucun email/t√©l√©phone renseign√©.";
    }

    // on ferme la modale de cr√©ation, puis on ouvre la modale de choix
    closeModal("createTraineeModal");
    openModal("sendAccessModal");
  });

  // ‚úÖ 2) boutons de d√©cision
  document.getElementById("btnCreateNoSend")?.addEventListener("click", async ()=>{
    await createTrainee(false);
  });

  document.getElementById("btnCreateAndSend")?.addEventListener("click", async ()=>{
    await createTrainee(true);
  });

  // =========================
  // autosave (select + comment)
  // =========================
  let debounceTimers = {};

  async function saveField(traineeId, field, value){
    await fetch(`/api/sessions/${sessionId}/stagiaires/${traineeId}/update`, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ [field]: value })
    });
  }

  document.querySelectorAll("tr[data-trainee-id]").forEach(tr=>{
    const traineeId = tr.getAttribute("data-trainee-id");

  


    // select changes
    tr.querySelectorAll("select.sel").forEach(sel=>{
      sel.addEventListener("change", async ()=>{
        const field = sel.getAttribute("data-field");
        const value = sel.value;

        applyStatusPill(sel); // ‚úÖ recolor instant

        try{
          await saveField(traineeId, field, value);
          window.location.reload(); // recalcul conformit√©s
        }catch(e){
          alert("Erreur sauvegarde");
        }
      });
    });

    // comment autosave
    const comment = tr.querySelector("input.comment");
    if(comment){
      comment.addEventListener("input", ()=>{
        const field = comment.getAttribute("data-field");
        const value = comment.value;

        if(debounceTimers[traineeId]) clearTimeout(debounceTimers[traineeId]);
        debounceTimers[traineeId] = setTimeout(async ()=>{
          try{
            await saveField(traineeId, field, value);
          }catch(e){
            // silencieux
          }
        }, 450);
      });
    }

    // delete trainee
    const delBtn = tr.querySelector("[data-delete-trainee]");
    if(delBtn){
      delBtn.addEventListener("click", async ()=>{
        if(!confirm("Supprimer ce stagiaire ?")) return;
        delBtn.disabled = true;
        try{
          const r = await fetch(`/api/sessions/${sessionId}/trainees/${traineeId}/delete`, { method:"POST" });
          const res = await r.json();
          if(!r.ok || !res.ok){
            alert("Erreur suppression stagiaire");
            delBtn.disabled = false;
            return;
          }
          window.location.reload();
        }catch(e){
          alert("Erreur r√©seau");
        }finally{
          delBtn.disabled = false;
        }
      });
    }
  });

  // =========================
  // CNAPS refresh
  // =========================
  async function cnapsLookup(nom, prenom){
    const r = await fetch(`/api/cnaps_lookup?nom=${encodeURIComponent(nom)}&prenom=${encodeURIComponent(prenom)}`);
    return await r.json();
  }



  
</script>


{% endblock %}
