{% extends "base.html" %}
{% block content %}

<div class="breadcrumbs">
  <a href="{{ url_for('admin_sessions', **request.args) }}">‚Üê Retour sessions</a>
</div>

<div class="session-header">
  <div>
    <h1>{{ session.name }}</h1>
    <div class="meta-line">
      <span class="pill">{{ session.training_type }}</span>
      <span>Formation : <strong>{{ session.date_start|frdate }}</strong> ‚Üí <strong>{{ session.date_end|frdate }}</strong></span>
      <span>Examen : <strong>{{ session.exam_date|frdate }}</strong></span>

    </div>
  </div>

  <div class="session-stats">
    <div class="stat">
      <div class="stat-title">Stagiaires</div>
      <div class="stat-value">{{ stats.total }}</div>
    </div>
    <div class="stat">
      <div class="stat-title">Conformes</div>
      <div class="stat-value">{{ stats.conform_count }}</div>
    </div>
    <div class="stat">
      <div class="stat-title">Non conformes</div>
      <div class="stat-value">{{ stats.non_conform_count }}</div>
    </div>
    <div class="stat">
      <div class="stat-title">Session</div>
      <div class="stat-value">{{ "Conforme ‚úÖ" if stats.session_is_conform else "Non conforme ‚ùå" }}</div>
    </div>
  </div>
</div>

<div class="page-head">
  <h2>Stagiaires</h2>
  <button class="btn btn-primary" id="btnOpenCreateTrainee">+ Ajouter un stagiaire</button>
</div>

<div class="table-wrap full-bleed">
  <table class="table" id="traineesTable"
         data-session-id="{{ session.id }}"
         data-show-hosting="{{ '1' if show_hosting else '0' }}"
         data-show-vae="{{ '1' if show_vae else '0' }}">
    <thead>
      <tr>
        <th>Nom</th>
        <th>Pr√©nom</th>
        <th>Mail</th>
        <th>T√©l√©phone</th>

        <th>Convention</th>
        <th>Test Fran√ßais</th>
        <th>Dossier</th>
        <th>CNAPS</th>
        {% if show_hosting %}<th>H√©bergement</th>{% endif %}
        <th>Commentaire</th>
        {% if show_vae %}<th>VAE</th>{% endif %}
        <th>Financement</th>
        <th>Fiche</th>
        <th>Suppr.</th>
      </tr>
    </thead>

    <tbody>
      {% for t in trainees %}
      <tr class="row {% if t.comment %}row-warning{% endif %}" data-trainee-id="{{ t.id }}">
        <td>{{ t.last_name }}</td>
        <td>{{ t.first_name }}</td>
        <td class="mono">{{ t.email }}</td>
        <td class="mono">{{ t.phone }}</td>

        <td>
          <select class="status sel" data-field="convention_status">
            {% for v in enums.convention %}
              <option value="{{ v }}" {% if t.convention_status==v %}selected{% endif %}>
                {{ "PROCHAINEMENT" if v=="soon" else ("EN COURS DE SIGNATURE" if v=="signing" else "SIGN√âE") }}
              </option>
            {% endfor %}
          </select>
        </td>

<td>
  <select class="status sel" data-field="test_fr_status">
    <option value="soon" {% if t.test_fr_status=="soon" or not t.test_fr_status %}selected{% endif %}>PROCHAINEMENT</option>
    <option value="in_progress" {% if t.test_fr_status=="in_progress" %}selected{% endif %}>EN COURS</option>
    <option value="relance" {% if t.test_fr_status=="relance" %}selected{% endif %}>RELANC√â</option>
    <option value="validated" {% if t.test_fr_status=="validated" %}selected{% endif %}>VALID√â</option>
  </select>
</td>



        <td>
          <select class="status sel" data-field="dossier_status">
            <option value="complete" {% if t.dossier_status=="complete" %}selected{% endif %}>complet</option>
            <option value="incomplete" {% if t.dossier_status=="incomplete" %}selected{% endif %}>incomplet</option>
          </select>
        </td>

        <td>
          <div class="inline">
            <span class="cnaps" data-cnaps>{{ t.cnaps or "INCONNU" }}</span>
            <button class="mini-btn" data-refresh type="button">‚Üª</button>
          </div>
        </td>

        {% if show_hosting %}
        <td>
          <span class="hosting" data-hosting>
            {{ "r√©serv√©" if t.hosting_status=="reserved" else ("inconnu" if t.hosting_status=="unknown" else t.hosting_status) }}
          </span>
        </td>
        {% endif %}

        <td>
          <input class="comment" data-field="comment" value="{{ t.comment }}" placeholder="Ajouter un commentaire...">
        </td>

        {% if show_vae %}
        <td>
  <select class="status sel" data-field="vae_status">
    <option value="soon" {% if t.vae_status=="soon" or not t.vae_status %}selected{% endif %}>
      PROCHAINEMENT
    </option>
    <option value="in_progress" {% if t.vae_status=="in_progress" %}selected{% endif %}>
      EN COURS
    </option>
    <option value="validated" {% if t.vae_status=="validated" %}selected{% endif %}>
      VALID√â
    </option>
  </select>
</td>

        {% endif %}

        <td>
          <select class="status sel" data-field="financement_status">
            <option value="soon" {% if t.financement_status=="soon" %}selected{% endif %}>prochainement</option>
            <option value="in_review" {% if t.financement_status=="in_review" %}selected{% endif %}>en cours de validation</option>
            <option value="validated" {% if t.financement_status=="validated" %}selected{% endif %}>valid√©</option>
          </select>
        </td>

        <td>
          <a class="btn btn-outline"
             href="/admin/sessions/{{ session.id }}/stagiaires/{{ t.id }}"
             style="text-decoration:none;display:inline-block">
            Fiche
          </a>
          <div class="small mono">ID: {{ t.personal_id }}</div>
          {% if t.comment %}
            <div class="warn-line">‚ö†Ô∏è</div>
          {% endif %}
        </td>

        <td>
          <button class="btn btn-danger" data-delete-trainee type="button">üóëÔ∏è</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- MODALE CREATION STAGIAIRE -->
<div class="modal-backdrop" id="createTraineeModal" aria-hidden="true">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title">Ajouter un stagiaire</div>
      <button class="icon-btn" data-close-modal="createTraineeModal">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="form-grid">
        <label>
          <div class="label">Nom</div>
          <input id="tLastName" type="text" placeholder="Nom">
        </label>
        <label>
          <div class="label">Pr√©nom</div>
          <input id="tFirstName" type="text" placeholder="Pr√©nom">
        </label>
        <label>
          <div class="label">Adresse mail</div>
          <input id="tEmail" type="email" placeholder="email@exemple.com">
        </label>
        <label>
          <div class="label">T√©l√©phone</div>
          <input id="tPhone" type="tel" placeholder="+33600000000">
          <div class="hint">Format conseill√© : +33‚Ä¶</div>
        </label>
        <label style="display:flex;align-items:center;gap:10px;margin-top:8px;">
  <input id="tCarteProOk" type="checkbox" style="width:18px;height:18px;">
  <div class="label" style="margin:0;">Carte professionnelle (CNAPS) d√©j√† OK</div>
</label>

      </div>
    </div>

    <div class="modal-foot">
      <button class="btn" data-close-modal="createTraineeModal">Annuler</button>
      <button class="btn btn-primary" id="btnCreateTrainee">Sauvegarder</button>
    </div>
  </div>
</div>

<script>
  const sessionId = document.getElementById("traineesTable").getAttribute("data-session-id");

  // =========================
  // UI: colors for status selects + CNAPS + Hosting
  // =========================
  function toClassSafe(s){
    return (s || "").toString().trim().toLowerCase().replace(/\s+/g,"_");
  }

  function applyStatusPill(selectEl){
    if(!selectEl) return;
    selectEl.classList.add("status-pill");

    [...selectEl.classList].forEach(c=>{
      if(c.startsWith("is-")) selectEl.classList.remove(c);
    });

    const v = toClassSafe(selectEl.value);
    if(v) selectEl.classList.add("is-" + v);
    else selectEl.classList.add("is-soon");
  }

  function cnapsClassFromText(txt){
    const t = (txt || "").toString().trim().toUpperCase();
    if(t.includes("TRANSM")) return "cnaps-transmis";
    if(t.includes("ENREG"))  return "cnaps-enregistre";
    if(t.includes("INSTRU")) return "cnaps-instruction";
    if(t.includes("ACCEPT")) return "cnaps-accepte";
    if(t.includes("REFUS"))  return "cnaps-refuse";
    if(t.includes("DOC"))    return "cnaps-docs";
    return "cnaps-inconnu";
  }

  function applyCnapsBadge(span){
    if(!span) return;
    span.classList.add("cnaps");
    [...span.classList].forEach(c=>{
      if(c.startsWith("cnaps-")) span.classList.remove(c);
    });
    span.classList.add(cnapsClassFromText(span.textContent));
  }

  function applyHostingBadge(span){
    if(!span) return;
    span.classList.add("status-pill");
    [...span.classList].forEach(c=>{
      if(c.startsWith("is-")) span.classList.remove(c);
    });

    const v = toClassSafe(span.textContent);
    if(v.includes("reserved") || v.includes("r√©serv")) span.classList.add("is-reserved");
    else span.classList.add("is-unknown");
  }

  function applyAllColors(){
    document.querySelectorAll("select.sel").forEach(sel => applyStatusPill(sel));
    document.querySelectorAll("[data-cnaps]").forEach(span => applyCnapsBadge(span));
    document.querySelectorAll("[data-hosting]").forEach(span => applyHostingBadge(span));
  }

  // ‚úÖ applique les couleurs au chargement
  applyAllColors();

  // =========================
  // modal open
  // =========================
  document.getElementById("btnOpenCreateTrainee")?.addEventListener("click", ()=>{
    openModal("createTraineeModal");
  });

  // =========================
  // create trainee
  // =========================
  document.getElementById("btnCreateTrainee")?.addEventListener("click", async ()=>{
    const last_name = (document.getElementById("tLastName").value || "").trim();
    const first_name = (document.getElementById("tFirstName").value || "").trim();
    const email = (document.getElementById("tEmail").value || "").trim();
    const phone = (document.getElementById("tPhone").value || "").trim();
    const carte_pro_ok = !!document.getElementById("tCarteProOk")?.checked;


    if(!last_name || !first_name){
      alert("Nom + pr√©nom obligatoires");
      return;
    }

    const btn = document.getElementById("btnCreateTrainee");
    btn.disabled = true;

    try{
      const r = await fetch(`/api/sessions/${sessionId}/trainees/create`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ last_name, first_name, email, phone, carte_pro_ok })
      });
      const res = await r.json();
      if(!r.ok || !res.ok){
        alert("Erreur ajout stagiaire");
        return;
      }
      window.location.reload();
    }catch(e){
      alert("Erreur r√©seau");
    }finally{
      btn.disabled = false;
    }
  });

  // =========================
  // autosave (select + comment)
  // =========================
  let debounceTimers = {};

  async function saveField(traineeId, field, value){
    await fetch(`/api/sessions/${sessionId}/stagiaires/${traineeId}/update`, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ [field]: value })
    });
  }

  document.querySelectorAll("tr[data-trainee-id]").forEach(tr=>{
    const traineeId = tr.getAttribute("data-trainee-id");

  


    // select changes
    tr.querySelectorAll("select.sel").forEach(sel=>{
      sel.addEventListener("change", async ()=>{
        const field = sel.getAttribute("data-field");
        const value = sel.value;

        applyStatusPill(sel); // ‚úÖ recolor instant

        try{
          await saveField(traineeId, field, value);
          window.location.reload(); // recalcul conformit√©s
        }catch(e){
          alert("Erreur sauvegarde");
        }
      });
    });

    // comment autosave
    const comment = tr.querySelector("input.comment");
    if(comment){
      comment.addEventListener("input", ()=>{
        const field = comment.getAttribute("data-field");
        const value = comment.value;

        if(debounceTimers[traineeId]) clearTimeout(debounceTimers[traineeId]);
        debounceTimers[traineeId] = setTimeout(async ()=>{
          try{
            await saveField(traineeId, field, value);
          }catch(e){
            // silencieux
          }
        }, 450);
      });
    }

    // delete trainee
    const delBtn = tr.querySelector("[data-delete-trainee]");
    if(delBtn){
      delBtn.addEventListener("click", async ()=>{
        if(!confirm("Supprimer ce stagiaire ?")) return;
        delBtn.disabled = true;
        try{
          const r = await fetch(`/api/sessions/${sessionId}/trainees/${traineeId}/delete`, { method:"POST" });
          const res = await r.json();
          if(!r.ok || !res.ok){
            alert("Erreur suppression stagiaire");
            delBtn.disabled = false;
            return;
          }
          window.location.reload();
        }catch(e){
          alert("Erreur r√©seau");
        }finally{
          delBtn.disabled = false;
        }
      });
    }
  });

  // =========================
  // CNAPS refresh
  // =========================
  async function cnapsLookup(nom, prenom){
    const r = await fetch(`/api/cnaps_lookup?nom=${encodeURIComponent(nom)}&prenom=${encodeURIComponent(prenom)}`);
    return await r.json();
  }

  document.querySelectorAll("[data-refresh]").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      e.preventDefault();

      const tr = btn.closest("tr");
      const traineeId = tr.getAttribute("data-trainee-id");

      const nom = tr.querySelector("td:nth-child(1)")?.textContent.trim() || "";
      const prenom = tr.querySelector("td:nth-child(2)")?.textContent.trim() || "";

      if (!traineeId || !nom || !prenom) {
        alert("Nom / pr√©nom introuvables");
        return;
      }

      btn.disabled = true;

      try {
        const res = await cnapsLookup(nom, prenom);
        const statut = (res.statut_cnaps || "INCONNU").toUpperCase();

        const span = tr.querySelector("[data-cnaps]");
        if (span){
          span.textContent = statut;
          applyCnapsBadge(span); // ‚úÖ recolor instant
        }

        await fetch(`/api/sessions/${sessionId}/stagiaires/${traineeId}/update`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ cnaps: statut })
        });

      } catch (err) {
        alert("Erreur CNAPS");
      } finally {
        btn.disabled = false;
      }
    });
  });
</script>


{% endblock %}
