{% extends "base.html" %}
{% block content %}

<style>
  .public-wrap{max-width:1100px;margin:0 auto;padding:18px;}
  .grid{display:grid;grid-template-columns:1fr;gap:14px;}
  @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr;} }

  .card{background:#fff;border:1px solid #e8eef3;border-radius:16px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.03);}
  .card h2{margin:0 0 10px 0;font-size:18px}
  .muted{color:#6b7280;font-size:13px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .line{display:flex;justify-content:space-between;gap:10px;padding:8px 0;border-top:1px dashed #edf2f7}
  .line:first-child{border-top:none;padding-top:0}
  .label{font-weight:800}
  .value{font-weight:700}

  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px;border:1px solid #e5e7eb;background:#f9fafb}
  .pill.red{background:#fff1f2;border-color:#fecdd3;color:#9f1239}
  .pill.orange{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
  .pill.yellow{background:#fefce8;border-color:#fde68a;color:#854d0e}
  .pill.green{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
  .pill.gray{background:#f3f4f6;border-color:#e5e7eb;color:#374151}
  .pill.blue{background:#eff6ff;border-color:#bfdbfe;color:#1d4ed8}

  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border-radius:12px;padding:10px 12px;font-weight:900;border:1px solid #e5e7eb;background:#111827;color:#fff;text-decoration:none;cursor:pointer}
  .btn.outline{background:#fff;color:#111827}
  .btn.small{padding:8px 10px;border-radius:10px;font-size:13px}
  .hint{background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:10px}
  .oktag{font-weight:900;color:#065f46}

  .field{display:flex;flex-direction:column;gap:6px;margin-top:10px}
  .field input{border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;font-weight:700}
  .saved{font-size:12px;color:#065f46;font-weight:900;display:none}
  .saved.show{display:inline-block}

  .docrow{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;padding:10px 0;border-top:1px dashed #edf2f7}
  .docrow:first-child{border-top:none;padding-top:0}
  .docmeta{display:flex;flex-direction:column;gap:2px}
</style>

{% set training_type = (session.training_type or '') %}
{% set formation_name = (session.name or session.training_type or '') %}

{# helpers de couleur pour statuts #}
{% macro pill_for(kind, value) %}
  {% set v = (value or '') %}
  {% set u = v|string %}
  {% set up = u.upper() %}
  {% set cls = 'gray' %}

  {# Convention #}
  {% if kind=='convention' %}
    {% if v=='signed' %}{% set cls='green' %}
    {% elif v=='signing' %}{% set cls='yellow' %}
    {% else %}{% set cls='red' %}{% endif %}
  {% endif %}

  {# Dossier #}
  {% if kind=='dossier' %}
    {% if v=='complete' %}{% set cls='green' %}
    {% else %}{% set cls='red' %}{% endif %}
  {% endif %}

  {# Test FR #}
  {% if kind=='test_fr' %}
    {% if v=='validated' %}{% set cls='green' %}
    {% elif v=='relance' %}{% set cls='orange' %}
    {% elif v=='in_progress' %}{% set cls='yellow' %}
    {% else %}{% set cls='red' %}{% endif %}
  {% endif %}

  {# Financement #}
  {% if kind=='financement' %}
    {% if v=='validated' %}{% set cls='green' %}
    {% elif v=='in_review' %}{% set cls='yellow' %}
    {% else %}{% set cls='red' %}{% endif %}
  {% endif %}

  {# Hébergement #}
  {% if kind=='hosting' %}
    {% if v=='reserved' %}{% set cls='green' %}
    {% else %}{% set cls='red' %}{% endif %}
  {% endif %}

  {# CNAPS #}
  {% if kind=='cnaps' %}
    {% if up in ['DELIVREE','DÉLIVRÉE','VALIDE','VALIDEE','VALIDÉE'] %}{% set cls='green' %}
    {% elif up in ['INSTRUCTION','EN INSTRUCTION','EN_INSTRUCTION'] %}{% set cls='yellow' %}
    {% elif up in ['REFUSEE','REFUSÉE','EXPIREE','EXPIRÉE'] %}{% set cls='red' %}
    {% else %}{% set cls='gray' %}{% endif %}
  {% endif %}

{# texte affiché #}
{% set text = u if u else '—' %}

{# Convention #}
{% if kind=='convention' %}
  {% if v=='signed' %}{% set text='SIGNÉE' %}
  {% elif v=='signing' %}{% set text='EN COURS DE SIGNATURE' %}
  {% else %}{% set text='À VENIR' %}{% endif %}
{% endif %}

{# Dossier #}
{% if kind=='dossier' %}
  {% if v=='complete' %}{% set text='COMPLET' %}
  {% else %}{% set text='INCOMPLET' %}{% endif %}
{% endif %}

{# Test FR #}
{% if kind=='test_fr' %}
  {% if v=='validated' %}{% set text='VALIDÉ' %}
  {% elif v=='relance' %}{% set text='RELANCÉ' %}
  {% elif v=='in_progress' %}{% set text='EN COURS' %}
  {% else %}{% set text='À FAIRE' %}{% endif %}
{% endif %}

{# Financement #}
{% if kind=='financement' %}
  {% if v=='validated' %}{% set text='VALIDÉ' %}
  {% elif v=='in_review' %}{% set text='EN COURS' %}
  {% else %}{% set text='À VENIR' %}{% endif %}
{% endif %}

{# Hébergement #}
{% if kind=='hosting' %}
  {% if v=='reserved' %}{% set text='RÉSERVÉ' %}
  {% else %}{% set text='INCONNU' %}{% endif %}
{% endif %}

{# CNAPS #}
{% if kind=='cnaps' %}
  {% if up in ['DELIVREE','DÉLIVRÉE','VALIDE','VALIDEE','VALIDÉE'] %}{% set cls='green' %}
  {% elif up in ['INSTRUCTION','EN INSTRUCTION','EN_INSTRUCTION'] %}{% set cls='yellow' %}
  {% elif up in ['REFUSEE','REFUSÉE','EXPIREE','EXPIRÉE'] %}{% set cls='red' %}
  {% elif up in ['INCONNU','UNKNOWN',''] %}{% set cls='red' %}
  {% else %}{% set cls='gray' %}{% endif %}
{% endif %}


<span class="pill {{cls}}">
  {{ text }}
</span>

{% endmacro %}

<div class="public-wrap">
  <div class="row" style="justify-content:space-between;margin-bottom:10px;">
    <div>
      <div style="font-size:26px;font-weight:1000;">Espace stagiaire</div>
      <div class="muted">Vos informations et documents — Intégrale Academy</div>
    </div>
  </div>

  <div class="grid">

    <!-- Encadré 1 : infos générales -->
    <div class="card">
      <h2>Infos générales</h2>

      <div class="line">
        <div class="label">Nom</div>
        <div class="value">{{ trainee.last_name }}</div>
      </div>
      <div class="line">
        <div class="label">Prénom</div>
        <div class="value">{{ trainee.first_name }}</div>
      </div>
      <div class="line">
        <div class="label">Formation</div>
        <div class="value">{{ formation_name }}</div>
      </div>
      <div class="line">
        <div class="label">Dates de formation</div>
        <div class="value">{{ session.date_start }} → {{ session.date_end }}</div>
      </div>
      <div class="line">
        <div class="label">Date d’examen</div>
        <div class="value">{{ session.exam_date }}</div>
      </div>
    </div>

    <!-- Encadré 2 : suivi de dossier -->
    <div class="card">
      <h2>Suivi de dossier</h2>

      <div class="docrow">
  <div class="docmeta"><div class="label">Inscription validée</div></div>
  <span class="pill green">✅ VALIDÉE</span>
</div>


      <div class="docrow">
        <div class="docmeta"><div class="label">Convention de formation</div></div>
        {{ pill_for('convention', trainee.convention_status) }}
      </div>

      <div class="docrow">
        <div class="docmeta"><div class="label">Dossier</div></div>
        {{ pill_for('dossier', trainee.dossier_status) }}
      </div>

      <div class="docrow">
        <div class="docmeta"><div class="label">CNAPS</div></div>
        {{ pill_for('cnaps', trainee.cnaps) }}
      </div>

      <div class="docrow">
        <div class="docmeta"><div class="label">Test de français</div></div>
        {{ pill_for('test_fr', trainee.test_fr_status) }}
      </div>

      <div class="docrow">
        <div class="docmeta"><div class="label">Financement</div></div>
        {{ pill_for('financement', trainee.financement_status) }}
      </div>

      {% if show_hosting %}
        <div class="docrow">
          <div class="docmeta"><div class="label">Hébergement</div></div>
          {{ pill_for('hosting', trainee.hosting_status) }}
        </div>

        {% if (trainee.hosting_status or 'unknown') == 'unknown' %}
          <div class="hint">
            <div style="font-weight:900;margin-bottom:6px;">Hébergement non réservé</div>
            Pour réserver l’hébergement :
            <a class="btn outline small" target="_blank" href="https://assistance-alw9.onrender.com/hebergement">Cliquez ici</a>
          </div>
        {% endif %}
      {% endif %}
    </div>

    <!-- Encadré : infos à compléter (autosave) -->
<div class="card">
  <h2>Infos à compléter</h2>
  <div class="muted" style="margin-bottom:10px;">
    ⚠️ Ces informations sont <strong>obligatoires</strong>.  
    Tant qu’un champ est incomplet, il apparaît en <span style="color:#b91c1c;font-weight:900;">rouge</span>.
  </div>

{% macro field(label, id, value, placeholder) %}
  {% set ok = value and value|length > 3 %}
  <div class="field" style="border-left:4px solid {{ '#16a34a' if ok else '#dc2626' }};padding-left:10px;">
    <label class="label">{{ label }}</label>

    <div style="display:flex;gap:10px;align-items:center;">
      <input id="{{ id }}" value="{{ value or '' }}" placeholder="{{ placeholder }}" style="flex:1;">
      <span id="ok_{{ id }}" class="saved show" style="min-width:110px;text-align:right;{% if ok %}color:#16a34a;{% else %}color:#dc2626;{% endif %}">
        {% if ok %}✅{% else %}⚠️ À compléter{% endif %}
      </span>
    </div>
  </div>
{% endmacro %}


  {{ field("Numéro de sécurité sociale",
           "carte_vitale",
           trainee.carte_vitale,
           "Ex : 1 85 12 34 567 890 12") }}

  {{ field("Numéro PRE",
           "pre_number",
           trainee.pre_number,
           "Ex : PRE-083-2025-12-01-20250000000 ou CAR-083-2025-12-01-20250000000") }}

  {{ field("Date de naissance",
           "birth_date",
           trainee.birth_date,
           "Ex : 1998-04-23") }}

  {{ field("Ville de naissance",
           "birth_city",
           trainee.birth_city,
           "Ex : Marseille") }}

  {{ field("Pays de naissance",
           "birth_country",
           trainee.birth_country,
           "Ex : France") }}

  {{ field("Nationalité",
           "nationality",
           trainee.nationality,
           "Ex : Française") }}

  {{ field("Adresse postale",
           "address",
           trainee.address,
           "Ex : 12 rue de la République") }}

  {{ field("Code postal",
           "zip_code",
           trainee.zip_code,
           "Ex : 75001") }}

  {{ field("Ville",
           "city",
           trainee.city,
           "Ex : Paris") }}
</div>

    </div>

    <!-- Encadré STATUT VAE (si DIRIGEANT VAE) -->
    {% if show_vae %}
    <div class="card">
      <h2>Statut VAE</h2>
      <div class="muted">Lecture seule (mis à jour par l’administration).</div>

      {% set v = trainee.vae_status or '' %}
      <div class="row" style="margin-top:10px;">
        <span class="pill blue">Statut : {{ v if v else '—' }}</span>
      </div>
    </div>
    {% endif %}

    <!-- Encadré 3 : mes documents (upload) -->
    <div class="card" style="grid-column:1/-1;">
      <h2>Mes documents</h2>
      <div class="muted">Déposez vos documents. Un tag “Enregistré” apparaît après upload.</div>

      {% set docs = trainee.documents or [] %}
      {% set id_doc = (docs | selectattr("key","equalto","id") | list | first) %}
      {% set photo_doc = (docs | selectattr("key","equalto","photo") | list | first) %}

      <div class="docrow">
        <div class="docmeta">
          <div class="label">Carte d’identité recto/verso ou passeport</div>
          <div class="muted">PDF uniquement</div>
          {% if id_doc and id_doc.file %}
            <div class="oktag">✅ Enregistré</div>
          {% endif %}
        </div>

        <form action="/espace/{{ token }}/documents/id/upload" method="post" enctype="multipart/form-data">
          <input type="file" name="file" accept="application/pdf" required>
          <button class="btn small" type="submit">Télécharger</button>
        </form>
      </div>

      <div class="docrow">
        <div class="docmeta">
          <div class="label">Photo d’identité</div>
          <div class="muted">JPEG ou PNG</div>
          {% if photo_doc and photo_doc.file %}
            <div class="oktag">✅ Enregistré</div>
          {% endif %}
        </div>

        <form action="/espace/{{ token }}/documents/photo/upload" method="post" enctype="multipart/form-data">
          <input type="file" name="file" accept="image/jpeg,image/png" required>
          <button class="btn small" type="submit">Télécharger</button>
        </form>
      </div>
    </div>

    <!-- Encadré 4 : diplômes et attestations -->
    <div class="card" style="grid-column:1/-1;">
      <h2>Mes diplômes et attestations</h2>
      <div class="muted">Quand l’administration dépose un document, il apparaît ici.</div>

      {% set d = trainee.deliverables or {} %}

      <div class="docrow">
        <div class="docmeta"><div class="label">Ma carte SST</div></div>
        {% if d.get('carte_sst') %}
          <a class="btn outline small" target="_blank" href="/admin/uploads/{{ d.get('carte_sst') }}">Voir</a>
        {% else %}
          <span class="pill gray">Prochainement</span>
        {% endif %}
      </div>

      <div class="docrow">
        <div class="docmeta"><div class="label">Mon diplôme</div></div>
        {% if d.get('diplome') %}
          <a class="btn outline small" target="_blank" href="/admin/uploads/{{ d.get('diplome') }}">Voir</a>
        {% else %}
          <span class="pill gray">Prochainement</span>
        {% endif %}
      </div>

      <div class="docrow">
        <div class="docmeta"><div class="label">Mes attestations de fin de formation</div></div>
        {% if d.get('attestation_fin_formation') %}
          <a class="btn outline small" target="_blank" href="/admin/uploads/{{ d.get('attestation_fin_formation') }}">Voir</a>
        {% else %}
          <span class="pill gray">Prochainement</span>
        {% endif %}
      </div>
    </div>

  </div>
</div>

<script>
  const token = "{{ token }}";

  function flashSaved(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.add("show");
    setTimeout(()=>el.classList.remove("show"), 1200);
  }

function setFieldState(inputId){
  const input = document.getElementById(inputId);
  const ok = document.getElementById("ok_" + inputId);
  if(!input || !ok) return;

  const v = (input.value || "").trim();
  if(v.length > 0){
    input.style.borderColor = "#bbf7d0";
    ok.textContent = "✅";
    ok.style.color = "#16a34a";
  }else{
    input.style.borderColor = "#fecdd3";
    ok.textContent = "⚠️ À compléter";
    ok.style.color = "#dc2626";
  }
}


  let tmr = null;
  function autosave(){
    clearTimeout(tmr);
    tmr = setTimeout(async ()=>{

      const carte_vitale  = document.getElementById("carte_vitale")?.value || "";
      const pre_number    = document.getElementById("pre_number")?.value || "";

      const birth_date    = document.getElementById("birth_date")?.value || "";
      const birth_city    = document.getElementById("birth_city")?.value || "";
      const birth_country = document.getElementById("birth_country")?.value || "";
      const nationality   = document.getElementById("nationality")?.value || "";

      const address       = document.getElementById("address")?.value || "";
      const zip_code      = document.getElementById("zip_code")?.value || "";
      const city          = document.getElementById("city")?.value || "";

      applyFormatting();
      const r = await fetch(`/espace/${token}/infos/update`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          carte_vitale, pre_number,
          birth_date, birth_city, birth_country, nationality,
          address, zip_code, city
        })
      });

      if(r.ok){
        // ✅ feedback minimal: on montre que c'est enregistré
        flashSaved("saved_carte");
        flashSaved("saved_pre");

        // ✅ état “à compléter / ok” (on le fera joli après)
        setFieldStateValidated("carte_vitale");
        setFieldStateValidated("pre_number");
        setFieldStateValidated("birth_date");
        setFieldStateValidated("birth_city");
        setFieldStateValidated("birth_country");
        setFieldStateValidated("nationality");
        setFieldStateValidated("address");
        setFieldStateValidated("zip_code");
        setFieldStateValidated("city");


      }
    }, 400);
  }

  // listeners existants (garde-les si tu veux) + nouveaux
  [
    "carte_vitale","pre_number",
    "birth_date","birth_city","birth_country","nationality",
    "address","zip_code","city"
  ].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener("input", autosave);
  });

  // premier passage pour mettre rouge/✅ dès l'ouverture
  window.addEventListener("load", ()=>{
  setFieldStateValidated("carte_vitale");
  setFieldStateValidated("pre_number");
  setFieldStateValidated("birth_date");
  setFieldStateValidated("birth_city");
  setFieldStateValidated("birth_country");
  setFieldStateValidated("nationality");
  setFieldStateValidated("address");
  setFieldStateValidated("zip_code");
  setFieldStateValidated("city");


  });

  function digitsOnly(s){
  return (s || "").toString().replace(/\D+/g, "");
}

// Format Sécu : 15 chiffres (on affiche avec espaces pour lecture)
function formatSecuDisplay(digits){
  // 15 digits: 1 85 12 34 567 890 12
  const parts = [
    digits.slice(0,1),
    digits.slice(1,3),
    digits.slice(3,5),
    digits.slice(5,7),
    digits.slice(7,10),
    digits.slice(10,13),
    digits.slice(13,15),
  ].filter(p => p.length);
  return parts.join(" ");
}

function normalizePRE(s){
  return (s || "").toString().trim().toUpperCase().replace(/\s+/g, "");
}

function isValidSecu(digits){
  return digits.length === 15; // simple (on peut faire le vrai contrôle clé ensuite)
}

// PRE/CAR-083-2025-12-01-20250000000
function isValidPRE(v){
  if(!v) return false;
  return /^(PRE|CAR)-\d{3}-\d{4}-\d{2}-\d{2}-\d{11,}$/.test(v);
}

function applyFormatting(){
  const secu = document.getElementById("carte_vitale");
  if(secu){
    const d = digitsOnly(secu.value);
    secu.value = formatSecuDisplay(d).slice(0, 23); // limite visuelle
  }

  const pre = document.getElementById("pre_number");
  if(pre){
    pre.value = normalizePRE(pre.value);
  }
}

function setFieldStateValidated(inputId){
  const input = document.getElementById(inputId);
  const ok = document.getElementById("ok_" + inputId);
  if(!input || !ok) return;

  const raw = (input.value || "").trim();

  let valid = raw.length > 0;

  if(inputId === "carte_vitale"){
    valid = isValidSecu(digitsOnly(raw));
  }
  if(inputId === "pre_number"){
    valid = isValidPRE(normalizePRE(raw));
  }

  if(valid){
    input.style.borderColor = "#bbf7d0";
    ok.textContent = "✅";
    ok.style.color = "#16a34a";
  }else{
    input.style.borderColor = "#fecdd3";
    ok.textContent = "⚠️ À compléter";
    ok.style.color = "#dc2626";
  }
}

  
</script>


{% endblock %}
