{% extends "base.html" %}
{% block content %}

<style>
  .public-wrap{max-width:1100px;margin:0 auto;padding:18px;}
  .grid{display:grid;grid-template-columns:1fr;gap:14px;}
  @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr;} }

  .card{background:#fff;border:1px solid #e8eef3;border-radius:16px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.03);}
  .card h2{margin:0 0 10px 0;font-size:18px}
  .muted{color:#6b7280;font-size:13px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .line{display:flex;justify-content:space-between;gap:10px;padding:8px 0;border-top:1px dashed #edf2f7}
  .line:first-child{border-top:none;padding-top:0}
  .label{font-weight:800}
  .value{font-weight:700}

  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px;border:1px solid #e5e7eb;background:#f9fafb}
  .pill.red{background:#fff1f2;border-color:#fecdd3;color:#9f1239}
  .pill.orange{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
  .pill.yellow{background:#fefce8;border-color:#fde68a;color:#854d0e}
  .pill.green{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
  .pill.gray{background:#f3f4f6;border-color:#e5e7eb;color:#374151}
  .pill.blue{background:#eff6ff;border-color:#bfdbfe;color:#1d4ed8}

  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border-radius:12px;padding:10px 12px;font-weight:900;border:1px solid #e5e7eb;background:#111827;color:#fff;text-decoration:none;cursor:pointer}
  .btn.outline{background:#fff;color:#111827}
  .btn.small{padding:8px 10px;border-radius:10px;font-size:13px}
  .hint{background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:10px}
  .oktag{font-weight:900;color:#065f46}

  .field{display:flex;flex-direction:column;gap:6px;margin-top:10px}
  .field input{border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;font-weight:700}
  .saved{font-size:12px;color:#065f46;font-weight:900;display:none}
  .saved.show{display:inline-block}

  .docrow{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;padding:10px 0;border-top:1px dashed #edf2f7}
  .docrow:first-child{border-top:none;padding-top:0}
  .docmeta{display:flex;flex-direction:column;gap:2px}

    .docrow.missing{
    border:2px dashed #fecaca;
    background:#fff1f2;
    border-radius:14px;
    padding:12px;
  }
  .docrow.pending{
    border:2px solid #fed7aa;
    background:#fff7ed;
    border-radius:14px;
    padding:12px;
  }
  .doctag{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 12px;
    border-radius:999px;
    font-weight:900;
    font-size:12px;
    border:1px solid #e5e7eb;
    background:#fff;
  }
  .doctag.missing{
    border-color:#fecaca;
    color:#b91c1c;
    background:#fff;
  }
  .doctag.pending{
    border-color:#fed7aa;
    color:#9a3412;
    background:#fff;
  }

  
</style>

{% set tt = (session.training_type or '')|string|upper %}

{% if 'A3P' in tt %}
  {% set formation_label = "Agent de protection physique des personnes (A3P)" %}
{% elif 'APS' in tt %}
  {% set formation_label = "Agent de pr√©vention et de s√©curit√© (APS)" %}
{% elif 'DIRIGEANT' in tt or 'DESP' in tt %}
  {% set formation_label = "Dirigeant d'entreprise de s√©curit√© (DESP)" %}
{% else %}
  {# fallback : nom de session si tu l‚Äôas, sinon training_type #}
  {% set formation_label = (session.name or session.training_type or "‚Äî") %}
{% endif %}


{# helpers de couleur pour statuts #}
{% macro pill_for(kind, value) %}
  {% set v = (value or '') %}
  {% set u = v|string %}
  {% set up = u.upper() %}
  {% set cls = 'gray' %}

  {# Convention #}
  {% if kind=='convention' %}
    {% if v=='signed' %}{% set cls='green' %}
    {% elif v=='signing' %}{% set cls='yellow' %}
    {% else %}{% set cls='red' %}{% endif %}
  {% endif %}

  {# Dossier #}
  {% if kind=='dossier' %}
    {% if v=='complete' %}{% set cls='green' %}
    {% else %}{% set cls='red' %}{% endif %}
  {% endif %}

  {# Test FR #}
  {% if kind=='test_fr' %}
    {% if v=='validated' %}{% set cls='green' %}
    {% elif v=='relance' %}{% set cls='orange' %}
    {% elif v=='in_progress' %}{% set cls='yellow' %}
    {% else %}{% set cls='red' %}{% endif %}
  {% endif %}

  {# Financement #}
  {% if kind=='financement' %}
    {% if v=='validated' %}{% set cls='green' %}
    {% elif v=='in_review' %}{% set cls='yellow' %}
    {% else %}{% set cls='red' %}{% endif %}
  {% endif %}

  {# H√©bergement #}
  {% if kind=='hosting' %}
    {% if v=='reserved' %}{% set cls='green' %}
    {% else %}{% set cls='red' %}{% endif %}
  {% endif %}

  {# CNAPS #}
  {% if kind=='cnaps' %}
    {% if up in ['DELIVREE','D√âLIVR√âE','VALIDE','VALIDEE','VALID√âE'] %}{% set cls='green' %}
    {% elif up in ['INSTRUCTION','EN INSTRUCTION','EN_INSTRUCTION'] %}{% set cls='yellow' %}
    {% elif up in ['REFUSEE','REFUS√âE','EXPIREE','EXPIR√âE'] %}{% set cls='red' %}
    {% else %}{% set cls='gray' %}{% endif %}
  {% endif %}

{# texte affich√© #}
{% set text = u if u else '‚Äî' %}

{# Convention #}
{% if kind=='convention' %}
  {% if v=='signed' %}{% set text='SIGN√âE' %}
  {% elif v=='signing' %}{% set text='EN COURS DE SIGNATURE' %}
  {% else %}{% set text='PROCHAINEMENT' %}{% endif %}
{% endif %}

{# Dossier #}
{% if kind=='dossier' %}
  {% if v=='complete' %}{% set text='COMPLET' %}
  {% else %}{% set text='INCOMPLET' %}{% endif %}
{% endif %}

{# Test FR #}
{% if kind=='test_fr' %}
  {% if v=='validated' %}{% set text='VALID√â' %}
  {% elif v=='relance' %}{% set text='RELANC√â' %}
  {% elif v=='in_progress' %}{% set text='EN COURS' %}
  {% else %}{% set text='PROCHAINEMENT' %}{% endif %}
{% endif %}

{# Financement #}
{% if kind=='financement' %}
  {% if v=='validated' %}{% set text='VALID√â' %}
  {% elif v=='in_review' %}{% set text='EN COURS' %}
  {% else %}{% set text='PROCHAINEMENT' %}{% endif %}
{% endif %}

{# H√©bergement #}
{% if kind=='hosting' %}
  {% if v=='reserved' %}{% set text='R√âSERV√â' %}
  {% else %}{% set text='INCONNU' %}{% endif %}
{% endif %}

{# CNAPS #}
{% if kind=='cnaps' %}
  {% if up in ['DELIVREE','D√âLIVR√âE','VALIDE','VALIDEE','VALID√âE'] %}{% set cls='green' %}
  {% elif up in ['INSTRUCTION','EN INSTRUCTION','EN_INSTRUCTION'] %}{% set cls='yellow' %}
  {% elif up in ['REFUSEE','REFUS√âE','EXPIREE','EXPIR√âE'] %}{% set cls='red' %}
  {% elif up in ['INCONNU','UNKNOWN',''] %}{% set cls='red' %}
  {% else %}{% set cls='gray' %}{% endif %}
{% endif %}


<span class="pill {{cls}}">
  {{ text }}
</span>

{% endmacro %}

<div class="public-wrap">
  <div class="row" style="justify-content:space-between;margin-bottom:10px;">
    <div>
      <div style="font-size:26px;font-weight:1000;">Espace stagiaire</div>
      <div class="muted">Vos informations et documents ‚Äî Int√©grale Academy</div>
    </div>
  </div>

  <div class="grid">

    <!-- Encadr√© 1 : infos g√©n√©rales -->
    <div class="card">
      <h2>Infos g√©n√©rales</h2>

      <div class="line">
        <div class="label">Nom</div>
        <div class="value">{{ (trainee.last_name or '')|upper }}</div>
      </div>
      <div class="line">
        <div class="label">Pr√©nom</div>
        <div class="value">{{ (trainee.first_name or '')|upper }}</div>
      </div>
      <div class="line">
  <div class="label">Formation</div>
  <div class="value">{{ formation_label }}</div>
</div>
      <div class="line">
  <div class="label">Type</div>
  <div class="value">{{ session.training_type }}</div>
</div>


      <div class="line">
        <div class="label">Dates de formation</div>
        <div class="value">{{ session.date_start|frdate }} ‚Üí {{ session.date_end|frdate }}</div>
      </div>
      <div class="line">
        <div class="label">Date d‚Äôexamen</div>
        <div class="value">{{ session.exam_date|frdate }}</div>
      </div>
    </div>

    <!-- Encadr√© 2 : suivi de dossier -->
    <div class="card">
      <h2>Suivi de dossier</h2>

      <div class="docrow">
  <div class="docmeta"><div class="label">Inscription valid√©e</div></div>
  <span class="pill green">‚úÖ VALID√âE</span>
</div>


      <div class="docrow">
        <div class="docmeta"><div class="label">Convention de formation</div></div>
        {{ pill_for('convention', trainee.convention_status) }}
      </div>

      <div class="docrow">
        <div class="docmeta"><div class="label">Dossier</div></div>
        {{ pill_for('dossier', trainee.dossier_status) }}
      </div>

      <div class="docrow">
        <div class="docmeta"><div class="label">CNAPS</div></div>
        {{ pill_for('cnaps', trainee.cnaps) }}
      </div>

      <div class="docrow">
        <div class="docmeta"><div class="label">Test de fran√ßais</div></div>
        {{ pill_for('test_fr', trainee.test_fr_status) }}
      </div>

      <div class="docrow">
        <div class="docmeta"><div class="label">Financement</div></div>
        {{ pill_for('financement', trainee.financement_status) }}
      </div>

      {% if show_hosting %}
        <div class="docrow">
          <div class="docmeta"><div class="label">H√©bergement</div></div>
          {{ pill_for('hosting', trainee.hosting_status) }}
        </div>

        {% if (trainee.hosting_status or 'unknown') == 'unknown' %}
          <div class="hint">
            <div style="font-weight:900;margin-bottom:6px;">H√©bergement non r√©serv√©</div>
            Pour r√©server l‚Äôh√©bergement :
            <a class="btn outline small" target="_blank" href="https://assistance-alw9.onrender.com/hebergement">Cliquez ici</a>
          </div>
        {% endif %}
      {% endif %}
    </div>

<!-- Encadr√© : infos √† compl√©ter (autosave) -->
<div class="card" style="grid-column:1/-1;">
  <h2>Infos √† compl√©ter</h2>
  <div class="muted" style="margin-bottom:10px;">
    ‚ö†Ô∏è Ces informations sont <strong>obligatoires</strong>.  
    Tant qu‚Äôun champ est incomplet, il appara√Æt en <span style="color:#b91c1c;font-weight:900;">rouge</span>.
  </div>

{% macro field(label, id, value, placeholder) %}
  {% set ok = value and value|length > 3 %}
  <div class="field" style="border-left:4px solid {{ '#16a34a' if ok else '#dc2626' }};padding-left:10px;">
    <label class="label">{{ label }}</label>

    <div style="display:flex;gap:10px;align-items:center;">
      <input id="{{ id }}" value="{{ value or '' }}" placeholder="{{ placeholder }}" style="flex:1;">
      <span id="ok_{{ id }}" class="saved show" style="min-width:110px;text-align:right;{% if ok %}color:#16a34a;{% else %}color:#dc2626;{% endif %}">
        {% if ok %}‚úÖ{% else %}‚ö†Ô∏è √Ä compl√©ter{% endif %}
      </span>
    </div>
  </div>
{% endmacro %}


  {{ field("Num√©ro de s√©curit√© sociale",
           "carte_vitale",
           trainee.carte_vitale,
           "Ex : 1 85 12 34 567 890 12") }}

  {{ field("Num√©ro PRE",
           "pre_number",
           trainee.pre_number,
           "Ex : PRE-083-2025-12-01-20250000000 ou CAR-083-2025-12-01-20250000000") }}

  {{ field("Date de naissance",
           "birth_date",
           trainee.birth_date,
           "Ex : 1998-04-23") }}

  {{ field("Ville de naissance",
           "birth_city",
           trainee.birth_city,
           "Ex : Marseille") }}

  {{ field("Pays de naissance",
           "birth_country",
           trainee.birth_country,
           "Ex : France") }}

  {{ field("Nationalit√©",
           "nationality",
           trainee.nationality,
           "Ex : Fran√ßaise") }}

  {{ field("Adresse postale",
           "address",
           trainee.address,
           "Ex : 12 rue de la R√©publique") }}

  {{ field("Code postal",
           "zip_code",
           trainee.zip_code,
           "Ex : 75001") }}

  {{ field("Ville",
           "city",
           trainee.city,
           "Ex : Paris") }}
</div>

    </div>

    <!-- Encadr√© STATUT VAE (si DIRIGEANT VAE) -->
    {% if show_vae %}
    <div class="card">
      <h2>Statut VAE</h2>
      <div class="muted">Lecture seule (mis √† jour par l‚Äôadministration).</div>

      {% set v = trainee.vae_status or '' %}
      <div class="row" style="margin-top:10px;">
        <span class="pill blue">Statut : {{ v if v else '‚Äî' }}</span>
      </div>
    </div>
    {% endif %}

<!-- Encadr√© 3 : mes documents (upload) -->
<div class="card" style="grid-column:1/-1;">
  <h2>Mes documents</h2>
  <div class="muted">D√©posez vos documents. Un tag s‚Äôaffiche apr√®s contr√¥le par l‚Äôadministration.</div>

  {% for d in (trainee.documents or []) %}
    {% set has_file = (d and d.file) %}
    {% set st = (d.status if d and d.status else ("NON D√âPOS√â" if not has_file else "A CONTR√îLER")) %}
    {% set up = (st|string)|upper %}

    {% set row_cls = "missing" %}
    {% if has_file %}
      {% if up == "CONFORME" %}
        {% set row_cls = "" %}
      {% elif up == "NON CONFORME" %}
        {% set row_cls = "missing" %}
      {% else %}
        {% set row_cls = "pending" %}
      {% endif %}
    {% endif %}

    {% set accept = (d.accept or "") %}
    {% set hint = "Fichier" %}
    {% if "application/pdf" in accept %}
      {% set hint = "PDF uniquement" %}
    {% elif "image/" in accept %}
      {% set hint = "JPEG ou PNG" %}
    {% endif %}

    <div class="docrow {{ row_cls }}">
      <div class="docmeta">
        <div class="label">{{ d.label }}</div>
        <div class="muted">{{ hint }}</div>

        {% if not has_file %}
          <div class="doctag missing">üìå Document √† d√©poser (obligatoire)</div>
        {% else %}
          {% if up == "CONFORME" %}
            <div class="doctag" style="border-color:#bbf7d0;color:#065f46;background:#fff;">‚úÖ Document conforme</div>
          {% elif up == "NON CONFORME" %}
            <div class="doctag missing">‚ùå Document non conforme ‚Äî √† remplacer</div>
          {% else %}
            <div class="doctag pending">‚è≥ Document d√©pos√© ‚Äî en attente de contr√¥le</div>
          {% endif %}
        {% endif %}
      </div>

      <form action="/espace/{{ token }}/documents/{{ d.key }}/upload" method="post" enctype="multipart/form-data">
        <input type="file" name="file" accept="{{ accept }}" required>
        <button class="btn small" type="submit">
          {% if has_file %}Remplacer{% else %}D√©poser{% endif %}
        </button>
      </form>
    </div>
  {% endfor %}
</div>



    <!-- Encadr√© 4 : dipl√¥mes et attestations -->
    <div class="card" style="grid-column:1/-1;">
      <h2>Mes dipl√¥mes et attestations</h2>



    {% set deliv = trainee.deliverables or {} %}

<div class="docrow">
  <div class="docmeta"><div class="label">Ma carte SST</div></div>
  {% if deliv.get('carte_sst') %}
    <a class="btn outline small" target="_blank"
       href="/admin/uploads/{{ deliv.get('carte_sst') }}">Voir</a>
  {% else %}
    <span class="pill gray">Prochainement</span>
  {% endif %}
</div>

<div class="docrow">
  <div class="docmeta"><div class="label">Mon dipl√¥me</div></div>
  {% if deliv.get('diplome') %}
    <a class="btn outline small" target="_blank"
       href="/admin/uploads/{{ deliv.get('diplome') }}">Voir</a>
  {% else %}
    <span class="pill gray">Prochainement</span>
  {% endif %}
</div>

<div class="docrow">
  <div class="docmeta"><div class="label">Mes attestations de fin de formation</div></div>
  {% if deliv.get('attestation_fin_formation') %}
    <a class="btn outline small" target="_blank"
       href="/admin/uploads/{{ deliv.get('attestation_fin_formation') }}">Voir</a>
  {% else %}
    <span class="pill gray">Prochainement</span>
  {% endif %}
</div>

    </div>

  </div>
</div>

<script>
  const token = "{{ token }}";

  function flashSaved(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.add("show");
    setTimeout(()=>el.classList.remove("show"), 1200);
  }

function setFieldState(inputId){
  const input = document.getElementById(inputId);
  const ok = document.getElementById("ok_" + inputId);
  const wrapper = input?.closest(".field"); // üëà LA CL√â EST L√Ä
  if(!input || !ok || !wrapper) return;

  const v = (input.value || "").trim();
  const valid = v.length > 0;

  if(valid){
    input.style.borderColor = "#bbf7d0";
    ok.textContent = "‚úÖ";
    ok.style.color = "#16a34a";
    wrapper.style.borderLeft = "4px solid #16a34a"; // üü¢ LIVE
  }else{
    input.style.borderColor = "#fecdd3";
    ok.textContent = "‚ö†Ô∏è √Ä compl√©ter";
    ok.style.color = "#dc2626";
    wrapper.style.borderLeft = "4px solid #dc2626"; // üî¥ LIVE
  }
}



  let tmr = null;
  function autosave(){
    clearTimeout(tmr);
    tmr = setTimeout(async ()=>{

      const carte_vitale  = document.getElementById("carte_vitale")?.value || "";
      const pre_number    = document.getElementById("pre_number")?.value || "";

      const birth_date    = document.getElementById("birth_date")?.value || "";
      const birth_city    = document.getElementById("birth_city")?.value || "";
      const birth_country = document.getElementById("birth_country")?.value || "";
      const nationality   = document.getElementById("nationality")?.value || "";

      const address       = document.getElementById("address")?.value || "";
      const zip_code      = document.getElementById("zip_code")?.value || "";
      const city          = document.getElementById("city")?.value || "";

      applyFormatting();
      const r = await fetch(`/espace/${token}/infos/update`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          carte_vitale, pre_number,
          birth_date, birth_city, birth_country, nationality,
          address, zip_code, city
        })
      });

      if(r.ok){
        // ‚úÖ feedback minimal: on montre que c'est enregistr√©
        flashSaved("saved_carte");
        flashSaved("saved_pre");

        // ‚úÖ √©tat ‚Äú√† compl√©ter / ok‚Äù (on le fera joli apr√®s)
        setFieldStateValidated("carte_vitale");
        setFieldStateValidated("pre_number");
        setFieldStateValidated("birth_date");
        setFieldStateValidated("birth_city");
        setFieldStateValidated("birth_country");
        setFieldStateValidated("nationality");
        setFieldStateValidated("address");
        setFieldStateValidated("zip_code");
        setFieldStateValidated("city");


      }
    }, 400);
  }

  // listeners existants (garde-les si tu veux) + nouveaux
  [
    "carte_vitale","pre_number",
    "birth_date","birth_city","birth_country","nationality",
    "address","zip_code","city"
  ].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener("input", autosave);
  });

  // premier passage pour mettre rouge/‚úÖ d√®s l'ouverture
  window.addEventListener("load", ()=>{
  setFieldStateValidated("carte_vitale");
  setFieldStateValidated("pre_number");
  setFieldStateValidated("birth_date");
  setFieldStateValidated("birth_city");
  setFieldStateValidated("birth_country");
  setFieldStateValidated("nationality");
  setFieldStateValidated("address");
  setFieldStateValidated("zip_code");
  setFieldStateValidated("city");


  });

  function digitsOnly(s){
  return (s || "").toString().replace(/\D+/g, "");
}

// Format S√©cu : 15 chiffres (on affiche avec espaces pour lecture)
function formatSecuDisplay(digits){
  // 15 digits: 1 85 12 34 567 890 12
  const parts = [
    digits.slice(0,1),
    digits.slice(1,3),
    digits.slice(3,5),
    digits.slice(5,7),
    digits.slice(7,10),
    digits.slice(10,13),
    digits.slice(13,15),
  ].filter(p => p.length);
  return parts.join(" ");
}

function normalizePRE(s){
  return (s || "").toString().trim().toUpperCase().replace(/\s+/g, "");
}

function isValidSecu(digits){
  return digits.length === 15; // simple (on peut faire le vrai contr√¥le cl√© ensuite)
}

// PRE/CAR-083-2025-12-01-20250000000
function isValidPRE(v){
  if(!v) return false;
  return /^(PRE|CAR)-\d{3}-\d{4}-\d{2}-\d{2}-\d{11,}$/.test(v);
}

function applyFormatting(){
  const secu = document.getElementById("carte_vitale");
  if(secu){
    const d = digitsOnly(secu.value);
    secu.value = formatSecuDisplay(d).slice(0, 23); // limite visuelle
  }

  const pre = document.getElementById("pre_number");
  if(pre){
    pre.value = normalizePRE(pre.value);
  }
}

function setFieldStateValidated(inputId){
  const input = document.getElementById(inputId);
  const ok = document.getElementById("ok_" + inputId);
  if(!input || !ok) return;

  const raw = (input.value || "").trim();

  let valid = raw.length > 0;

  if(inputId === "carte_vitale"){
    valid = isValidSecu(digitsOnly(raw));
  }
  if(inputId === "pre_number"){
    valid = isValidPRE(normalizePRE(raw));
  }

  if(valid){
    input.style.borderColor = "#bbf7d0";
    ok.textContent = "‚úÖ";
    ok.style.color = "#16a34a";
  }else{
    input.style.borderColor = "#fecdd3";
    ok.textContent = "‚ö†Ô∏è √Ä compl√©ter";
    ok.style.color = "#dc2626";
  }
}

  
</script>


{% endblock %}
