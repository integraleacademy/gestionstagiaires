{% extends "base.html" %}
{% block content %}

<style>
  .public-wrap{max-width:1100px;margin:0 auto;padding:18px;}
  .grid{display:grid;grid-template-columns:1fr;gap:14px;}
  @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr;} }

  .card{background:#fff;border:1px solid #e8eef3;border-radius:16px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.03);}
  .card h2{margin:0 0 10px 0;font-size:18px}
  .muted{color:#6b7280;font-size:13px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .line{display:flex;justify-content:space-between;gap:10px;padding:8px 0;border-top:1px dashed #edf2f7}
  .line:first-child{border-top:none;padding-top:0}
  .label{font-weight:800}
  .value{font-weight:700}

  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px;border:1px solid #e5e7eb;background:#f9fafb}
  .pill.red{background:#fff1f2;border-color:#fecdd3;color:#9f1239}
  .pill.orange{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
  .pill.yellow{background:#fefce8;border-color:#fde68a;color:#854d0e}
  .pill.green{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
  .pill.gray{background:#f3f4f6;border-color:#e5e7eb;color:#374151}
  .pill.blue{background:#eff6ff;border-color:#bfdbfe;color:#1d4ed8}

  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border-radius:12px;padding:10px 12px;font-weight:900;border:1px solid #e5e7eb;background:#111827;color:#fff;text-decoration:none;cursor:pointer}
  .btn.outline{background:#fff;color:#111827}
  .btn.small{padding:8px 10px;border-radius:10px;font-size:13px}
  .hint{background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:10px}
  .oktag{font-weight:900;color:#065f46}

  .field{display:flex;flex-direction:column;gap:6px;margin-top:10px}
  .field input{border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;font-weight:700}
  .saved{font-size:12px;color:#065f46;font-weight:900;display:none}
  .saved.show{display:inline-block}

  .docrow{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;padding:10px 0;border-top:1px dashed #edf2f7}
  .docrow:first-child{border-top:none;padding-top:0}
  .docmeta{display:flex;flex-direction:column;gap:2px}

    .docrow.missing{
    border:2px dashed #fecaca;
    background:#fff1f2;
    border-radius:14px;
    padding:12px;
  }
  .docrow.pending{
    border:2px solid #fed7aa;
    background:#fff7ed;
    border-radius:14px;
    padding:12px;
  }
  .doctag{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 12px;
    border-radius:999px;
    font-weight:900;
    font-size:12px;
    border:1px solid #e5e7eb;
    background:#fff;
  }
  .doctag.missing{
    border-color:#fecaca;
    color:#b91c1c;
    background:#fff;
  }
  .doctag.pending{
    border-color:#fed7aa;
    color:#9a3412;
    background:#fff;
  }

  
</style>

{% set tt = (session.training_type or '')|string|upper %}

{% if 'A3P' in tt %}
  {% set formation_label = "Agent de protection physique des personnes (A3P)" %}
{% elif 'APS' in tt %}
  {% set formation_label = "Agent de pr√©vention et de s√©curit√© (APS)" %}
{% elif 'DIRIGEANT' in tt or 'DESP' in tt %}
  {% set formation_label = "Dirigeant d'entreprise de s√©curit√© (DESP)" %}
{% else %}
  {# fallback : nom de session si tu l‚Äôas, sinon training_type #}
  {% set formation_label = (session.name or session.training_type or "‚Äî") %}
{% endif %}


{# helpers de couleur pour statuts #}
{% macro pill_for(kind, value) %}
  {% set v = (value or '') %}
  {% set u = v|string %}
  {% set up = u.upper() %}
  {% set cls = 'gray' %}

  {# Convention #}
  {% if kind=='convention' %}
    {% if v=='signed' %}{% set cls='green' %}
    {% elif v=='signing' %}{% set cls='yellow' %}
    {% else %}{% set cls='red' %}{% endif %}
  {% endif %}

  {# Dossier #}
  {% if kind=='dossier' %}
    {% if v=='complete' %}{% set cls='green' %}
    {% else %}{% set cls='red' %}{% endif %}
  {% endif %}

  {# Test FR #}
  {% if kind=='test_fr' %}
    {% if v=='validated' %}{% set cls='green' %}
    {% elif v=='relance' %}{% set cls='orange' %}
    {% elif v=='in_progress' %}{% set cls='yellow' %}
    {% else %}{% set cls='red' %}{% endif %}
  {% endif %}

  {# Financement #}
  {% if kind=='financement' %}
    {% if v=='validated' %}{% set cls='green' %}
    {% elif v=='in_review' %}{% set cls='yellow' %}
    {% else %}{% set cls='red' %}{% endif %}
  {% endif %}

  {# H√©bergement #}
  {% if kind=='hosting' %}
    {% if v=='reserved' %}{% set cls='green' %}
    {% else %}{% set cls='red' %}{% endif %}
  {% endif %}

  {# CNAPS #}
  {% if kind=='cnaps' %}
    {% if up in ['DELIVREE','D√âLIVR√âE','VALIDE','VALIDEE','VALID√âE'] %}{% set cls='green' %}
    {% elif up in ['INSTRUCTION','EN INSTRUCTION','EN_INSTRUCTION'] %}{% set cls='yellow' %}
    {% elif up in ['REFUSEE','REFUS√âE','EXPIREE','EXPIR√âE'] %}{% set cls='red' %}
    {% else %}{% set cls='gray' %}{% endif %}
  {% endif %}

{# texte affich√© #}
{% set text = u if u else '‚Äî' %}

{# Convention #}
{% if kind=='convention' %}
  {% if v=='signed' %}{% set text='SIGN√âE' %}
  {% elif v=='signing' %}{% set text='EN COURS DE SIGNATURE' %}
  {% else %}{% set text='PROCHAINEMENT' %}{% endif %}
{% endif %}

{# Dossier #}
{% if kind=='dossier' %}
  {% if v=='complete' %}{% set text='COMPLET' %}
  {% else %}{% set text='INCOMPLET' %}{% endif %}
{% endif %}

{# Test FR #}
{% if kind=='test_fr' %}
  {% if v=='validated' %}{% set text='VALID√â' %}
  {% elif v=='relance' %}{% set text='RELANC√â' %}
  {% elif v=='in_progress' %}{% set text='EN COURS' %}
  {% else %}{% set text='PROCHAINEMENT' %}{% endif %}
{% endif %}

{# Financement #}
{% if kind=='financement' %}
  {% if v=='validated' %}{% set text='VALID√â' %}
  {% elif v=='in_review' %}{% set text='EN COURS' %}
  {% else %}{% set text='PROCHAINEMENT' %}{% endif %}
{% endif %}

{# H√©bergement #}
{% if kind=='hosting' %}
  {% if v=='reserved' %}{% set text='R√âSERV√â' %}
  {% else %}{% set text='INCONNU' %}{% endif %}
{% endif %}

{# CNAPS #}
{% if kind=='cnaps' %}
  {% if up in ['DELIVREE','D√âLIVR√âE','VALIDE','VALIDEE','VALID√âE'] %}{% set cls='green' %}
  {% elif up in ['INSTRUCTION','EN INSTRUCTION','EN_INSTRUCTION'] %}{% set cls='yellow' %}
  {% elif up in ['REFUSEE','REFUS√âE','EXPIREE','EXPIR√âE'] %}{% set cls='red' %}
  {% elif up in ['INCONNU','UNKNOWN',''] %}{% set cls='red' %}
  {% else %}{% set cls='gray' %}{% endif %}
{% endif %}


<span class="pill {{cls}}">
  {{ text }}
</span>

{% endmacro %}

<div class="public-wrap">
  <div class="row" style="justify-content:space-between;margin-bottom:10px;">
    <div>
      <div style="font-size:26px;font-weight:1000;">Espace stagiaire</div>
      <div class="muted">Vos informations et documents ‚Äî Int√©grale Academy</div>
    </div>
  </div>

  <div class="grid">

    <!-- Encadr√© 1 : infos g√©n√©rales -->
    <div class="card">
      <h2>Infos g√©n√©rales</h2>

      <div class="line">
        <div class="label">Nom</div>
        <div class="value">{{ (trainee.last_name or '')|upper }}</div>
      </div>
      <div class="line">
        <div class="label">Pr√©nom</div>
        <div class="value">{{ (trainee.first_name or '')|upper }}</div>
      </div>
      <div class="line">
  <div class="label">Formation</div>
  <div class="value">{{ formation_label }}</div>
</div>
      <div class="line">
  <div class="label">Type</div>
  <div class="value">{{ session.training_type }}</div>
</div>


      <div class="line">
        <div class="label">Dates de formation</div>
        <div class="value">{{ session.date_start|frdate }} ‚Üí {{ session.date_end|frdate }}</div>
      </div>
      <div class="line">
        <div class="label">Date d‚Äôexamen</div>
        <div class="value">{{ session.exam_date|frdate }}</div>
      </div>
    </div>

    <!-- Encadr√© 2 : suivi de dossier -->
    <div class="card">
      <h2>Suivi de dossier</h2>

      <div class="docrow">
  <div class="docmeta"><div class="label">Inscription valid√©e</div></div>
  <span class="pill green">‚úÖ VALID√âE</span>
</div>


      <div class="docrow">
        <div class="docmeta"><div class="label">Convention de formation</div></div>
        {{ pill_for('convention', trainee.convention_status) }}
      </div>

      <div class="docrow">
        <div class="docmeta"><div class="label">Dossier</div></div>
        {{ pill_for('dossier', 'complete' if dossier_ok else 'incomplete') }}
      </div>

      <div class="docrow">
        <div class="docmeta"><div class="label">CNAPS</div></div>
        {{ pill_for('cnaps', trainee.cnaps) }}
      </div>

      <div class="docrow">
        <div class="docmeta"><div class="label">Test de fran√ßais</div></div>
        {{ pill_for('test_fr', trainee.test_fr_status) }}
      </div>

      <div class="docrow">
        <div class="docmeta"><div class="label">Financement</div></div>
        {{ pill_for('financement', trainee.financement_status) }}
      </div>

      {% if show_hosting %}
        <div class="docrow">
          <div class="docmeta"><div class="label">H√©bergement</div></div>
          {{ pill_for('hosting', trainee.hosting_status) }}
        </div>

        {% if (trainee.hosting_status or 'unknown') == 'unknown' %}
          <div class="hint">
            <div style="font-weight:900;margin-bottom:6px;">H√©bergement non r√©serv√©</div>
            Pour r√©server l‚Äôh√©bergement :
            <a class="btn outline small" target="_blank" href="https://assistance-alw9.onrender.com/hebergement">Cliquez ici</a>
          </div>
        {% endif %}
      {% endif %}
    </div>

<!-- Encadr√© : infos √† compl√©ter (autosave) -->
<div class="card" style="grid-column:1/-1;">
  <h2>Infos √† compl√©ter</h2>
<div class="muted" style="margin-bottom:10px;">
  ‚úÖ <strong>Tout ce que vous saisissez est enregistr√© automatiquement.</strong><br>
  ‚ö†Ô∏è Ces informations sont <strong>obligatoires</strong>.
  Quand un champ est incomplet, il appara√Æt en <span style="color:#b91c1c;font-weight:900;">rouge</span>.
</div>

{% macro field(label, id, value, placeholder) %}
  {% set ok = value and value|length > 3 %}
  <div class="field" style="border-left:4px solid {{ '#16a34a' if ok else '#dc2626' }};padding-left:10px;">
    <label class="label">{{ label }}</label>

    <div style="display:flex;gap:10px;align-items:center;">
      <input id="{{ id }}" value="{{ value or '' }}" placeholder="{{ placeholder }}" style="flex:1;">
      <span id="ok_{{ id }}" class="saved show" style="min-width:110px;text-align:right;{% if ok %}color:#16a34a;{% else %}color:#dc2626;{% endif %}">
        {% if ok %}‚úÖ{% else %}‚ö†Ô∏è √Ä compl√©ter{% endif %}
      </span>
    </div>
  </div>
{% endmacro %}


  {{ field("Num√©ro de s√©curit√© sociale",
           "carte_vitale",
           trainee.carte_vitale,
           "Ex : 1 85 12 34 567 890 12") }}

  {{ field("Num√©ro PRE",
           "pre_number",
           trainee.pre_number,
           "Ex : PRE-083-2025-12-01-20250000000 ou CAR-083-2025-12-01-20250000000") }}

{# Date de naissance (type date) #}
<div class="field" style="border-left:4px solid {{ '#16a34a' if (trainee.birth_date or '') else '#dc2626' }};padding-left:10px;">
  <label class="label">Date de naissance</label>

  <div style="display:flex;gap:10px;align-items:center;">
    <input id="birth_date"
           type="date"
           value="{{ trainee.birth_date or '' }}"
           style="flex:1;">
    <span id="ok_birth_date" class="saved show" style="min-width:110px;text-align:right;{% if (trainee.birth_date or '') %}color:#16a34a;{% else %}color:#dc2626;{% endif %}">
      {% if (trainee.birth_date or '') %}‚úÖ{% else %}‚ö†Ô∏è √Ä compl√©ter{% endif %}
    </span>
  </div>
</div>

  {{ field("Ville de naissance",
           "birth_city",
           trainee.birth_city,
           "Ex : Marseille") }}

  {{ field("Pays de naissance",
           "birth_country",
           trainee.birth_country,
           "Ex : France") }}

  {{ field("Nationalit√©",
           "nationality",
           trainee.nationality,
           "Ex : Fran√ßaise") }}

  {{ field("Adresse postale",
           "address",
           trainee.address,
           "Ex : 12 rue de la R√©publique") }}

  {{ field("Code postal",
           "zip_code",
           trainee.zip_code,
           "Ex : 75001") }}

  {{ field("Ville",
           "city",
           trainee.city,
           "Ex : Paris") }}
</div>

    </div>

    <!-- Encadr√© STATUT VAE (si DIRIGEANT VAE) -->
    {% if show_vae %}
    <div class="card">
      <h2>Statut VAE</h2>
      <div class="muted">Lecture seule (mis √† jour par l‚Äôadministration).</div>

      {% set v = trainee.vae_status or '' %}
      <div class="row" style="margin-top:10px;">
        <span class="pill blue">Statut : {{ v if v else '‚Äî' }}</span>
      </div>
    </div>
    {% endif %}

<!-- Encadr√© 3 : mes documents (upload) -->
<div class="card" style="grid-column:1/-1;">
  <h2>Mes documents</h2>
  <div class="muted">D√©posez ici vos documents.</div>

  {% for d in (trainee.documents or []) %}
{% set has_file = false %}
{% if d %}
  {% if d.files is defined and d.files is sequence and (d.files|length) > 0 %}
    {% set has_file = true %}
  {% elif d.file %}
    {% set has_file = true %}
  {% endif %}
{% endif %}
    {% set st = (d.status if d and d.status else ("NON D√âPOS√â" if not has_file else "A CONTR√îLER")) %}
    {% set up = (st|string)|upper %}
  {% set can_replace = (has_file and up == "NON CONFORME") %}
{% set show_upload = ((not has_file) or can_replace) and not (d.key == "permis" and trainee.no_permis) %}

    {% set row_cls = "missing" %}
    {% if has_file %}
      {% if up == "CONFORME" %}
        {% set row_cls = "" %}
      {% elif up == "NON CONFORME" %}
        {% set row_cls = "missing" %}
      {% else %}
        {% set row_cls = "pending" %}
      {% endif %}
    {% endif %}

    {% set accept = (d.accept or "") %}
    {% set hint = "Fichier" %}
    {% if "application/pdf" in accept %}
      {% set hint = "PDF uniquement" %}
    {% elif "image/" in accept %}
      {% set hint = "JPEG ou PNG" %}
    {% endif %}

<div class="docrow">
      <div class="docmeta">
        <div class="label">{{ d.label }}</div>
        {% if d.key == "permis" %}
  <label style="margin-top:8px;display:flex;align-items:center;gap:8px;font-weight:800;">
    <input
      type="checkbox"
      id="no_permis_checkbox"
      {% if trainee.no_permis %}checked{% endif %}
    >
    Je n‚Äôai pas le permis de conduire
  </label>

  <div class="muted" style="margin-top:4px;">
    Si vous cochez cette case, le d√©p√¥t du permis n‚Äôest pas obligatoire.
  </div>
{% endif %}

        {% if d.key == "permis" and trainee.no_permis %}
  <div class="doctag"
       style="margin-top:8px;border-color:#bbf7d0;color:#065f46;">
    ‚úÖ Permis non requis (d√©clar√©)
  </div>
{% endif %}
        
        <div class="muted">{{ hint }}</div>

{% if not has_file and not (d.key == "permis" and trainee.no_permis) %}
  <div class="doctag missing">üìå Document √† d√©poser (obligatoire)</div>
{% else %}
  {% if has_file %}
    {% if up == "CONFORME" %}
      <div class="doctag" style="border-color:#bbf7d0;color:#065f46;background:#fff;">‚úÖ Document conforme</div>
    {% elif up == "NON CONFORME" %}
      <div class="doctag missing">‚ùå Document non conforme ‚Äî √† remplacer</div>
    {% else %}
      <div class="doctag pending">‚è≥ Document d√©pos√© ‚Äî en attente de contr√¥le</div>
    {% endif %}
  {% endif %}
{% endif %}

{% if show_upload %}
<form class="upload-form"
id="upload_{{ d.key }}"
  action="/espace/{{ token }}/documents/{{ d.key }}/upload"
  method="post"
  enctype="multipart/form-data">

{% if d.key == "id" %}
  <div class="muted" style="font-weight:900;color:#111;margin-bottom:6px;">
    üìå Carte d‚Äôidentit√© obligatoire ‚Äî
    <span style="color:#b91c1c;">RECTO + VERSO (vous pouvez d√©poser 1 fichier si votre document contient recto/verso, sinon 2 fichiers)</span>
  </div>

  <input type="file"
         name="file"
         accept="{{ accept }}"
         required>
{% else %}
  <input type="file"
         name="file"
         accept="{{ accept }}"
         {% if not (d.key == "permis" and trainee.no_permis) %}required{% endif %}>
{% endif %}

<button class="btn small" type="submit">
  {% if can_replace %}Remplacer{% else %}D√©poser{% endif %}
</button>

<div class="uploading-msg" style="display:none;margin-top:8px;font-weight:900;">
  ‚è≥ Envoi en cours‚Ä¶
</div>
</form>
{% else %}
  <span class="pill green">üìé Fichier d√©j√† envoy√©</span>
{% endif %}

{% if d.key == "id" %}
  <div id="id_hint_id" style="display:none;margin-top:12px;border:2px solid #fed7aa;background:#fff7ed;padding:12px;border-radius:12px;">
    <div style="font-weight:900;color:#9a3412;margin-bottom:8px;">
      Avez-vous bien fourni votre passeport, ou votre carte d'identit√©
      <span style="color:#b91c1c;">RECTO / VERSO (2 c√¥t√©s)</span> ?
    </div>

    <div style="display:flex;gap:10px;">
      <button type="button" class="btn outline small" onclick="cancelIdUpload()">Modifier</button>
      <button type="button" class="btn small" onclick="confirmIdUpload()">Oui, je confirme</button>
    </div>
  </div>
{% endif %}

{% if d.key == "photo" %}
  <div id="photo_hint_photo" style="display:none;margin-top:12px;border:2px solid #fed7aa;background:#fff7ed;padding:12px;border-radius:12px;">
    <div style="font-weight:900;color:#9a3412;margin-bottom:8px;">
      Avez-vous bien fourni une photo d‚Äôidentit√© conforme ? (photo de face, sur fond neutre). Cette photo appara√Ætra sur votre dipl√¥me.
    </div>

    <img src="/static/photo-exemple.png"
         alt="Exemple photo identit√© conforme"
         style="max-width:240px;width:100%;border-radius:10px;border:1px solid #e5e7eb;display:block;margin-bottom:10px;">

    <div style="display:flex;gap:10px;">
      <button type="button" class="btn outline small" onclick="cancelPhotoUpload()">Modifier</button>
      <button type="button" class="btn small" onclick="confirmPhotoUpload()">Oui, je confirme</button>
    </div>
  </div>
{% endif %}

    </div>
  {% endfor %}
</div>
    <!-- Encadr√© 4 : dipl√¥mes et attestations -->
    <div class="card" style="grid-column:1/-1;">
      <h2>Mes dipl√¥mes et attestations</h2>



    {% set deliv = trainee.deliverables or {} %}

<div class="docrow">
  <div class="docmeta"><div class="label">Ma carte SST</div></div>
  {% if deliv.get('carte_sst') %}
    <a class="btn outline small" target="_blank"
       href="/admin/uploads/{{ deliv.get('carte_sst') }}">Voir</a>
  {% else %}
    <span class="pill gray">Prochainement</span>
  {% endif %}
</div>

<div class="docrow">
  <div class="docmeta"><div class="label">Mon dipl√¥me</div></div>
  {% if deliv.get('diplome') %}
    <a class="btn outline small" target="_blank"
       href="/admin/uploads/{{ deliv.get('diplome') }}">Voir</a>
  {% else %}
    <span class="pill gray">Prochainement</span>
  {% endif %}
</div>

<div class="docrow">
  <div class="docmeta"><div class="label">Mes attestations de fin de formation</div></div>
  {% if deliv.get('attestation_fin_formation') %}
    <a class="btn outline small" target="_blank"
       href="/admin/uploads/{{ deliv.get('attestation_fin_formation') }}">Voir</a>
  {% else %}
    <span class="pill gray">Prochainement</span>
  {% endif %}
</div>

    </div>

  </div>
</div>

<script>
  const token = "{{ token }}";

  // ‚úÖ Helpers formatage live
function digitsOnly(s){
  return (s || "").toString().replace(/\D+/g, "");
}


function applyFormattingLive(){
  // S√©cu
  const secu = document.getElementById("carte_vitale");
  if(secu){
    const d = digitsOnly(secu.value).slice(0, 15);
    secu.value = formatSecuDisplay(d);
  }

  // PRE
  const pre = document.getElementById("pre_number");
  if(pre){
    pre.value = normalizePRE(pre.value);
  }
}

  function flashSaved(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.add("show");
    setTimeout(()=>el.classList.remove("show"), 1200);
  }

function setFieldState(inputId){
  const input = document.getElementById(inputId);
  const ok = document.getElementById("ok_" + inputId);
  const wrapper = input?.closest(".field"); // üëà LA CL√â EST L√Ä
  if(!input || !ok || !wrapper) return;

  const v = (input.value || "").trim();
  const valid = v.length > 0;

  if(valid){
    input.style.borderColor = "#bbf7d0";
    ok.textContent = "‚úÖ";
    ok.style.color = "#16a34a";
    wrapper.style.borderLeft = "4px solid #16a34a"; // üü¢ LIVE
  }else{
    input.style.borderColor = "#fecdd3";
    ok.textContent = "‚ö†Ô∏è √Ä compl√©ter";
    ok.style.color = "#dc2626";
    wrapper.style.borderLeft = "4px solid #dc2626"; // üî¥ LIVE
  }
}



  let tmr = null;
  function autosave(){
    clearTimeout(tmr);
    tmr = setTimeout(async ()=>{

      const carte_vitale  = document.getElementById("carte_vitale")?.value || "";
      const pre_number    = document.getElementById("pre_number")?.value || "";

      const birth_date    = document.getElementById("birth_date")?.value || "";
      const birth_city    = document.getElementById("birth_city")?.value || "";
      const birth_country = document.getElementById("birth_country")?.value || "";
      const nationality   = document.getElementById("nationality")?.value || "";

      const address       = document.getElementById("address")?.value || "";
      const zip_code      = document.getElementById("zip_code")?.value || "";
      const city          = document.getElementById("city")?.value || "";

      applyFormatting();
      const r = await fetch(`/espace/${token}/infos/update`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          carte_vitale, pre_number,
          birth_date, birth_city, birth_country, nationality,
          address, zip_code, city
        })
      });

      if(r.ok){
        // ‚úÖ feedback minimal: on montre que c'est enregistr√©
        flashSaved("ok_carte_vitale");
        flashSaved("ok_pre_number");

        // ‚úÖ √©tat ‚Äú√† compl√©ter / ok‚Äù (on le fera joli apr√®s)
        setFieldStateValidated("carte_vitale");
        setFieldStateValidated("pre_number");
        setFieldStateValidated("birth_date");
        setFieldStateValidated("birth_city");
        setFieldStateValidated("birth_country");
        setFieldStateValidated("nationality");
        setFieldStateValidated("address");
        setFieldStateValidated("zip_code");
        setFieldStateValidated("city");


      }
    }, 400);
  }

  // listeners existants (garde-les si tu veux) + nouveaux
  [
  "carte_vitale","pre_number",
  "birth_date","birth_city","birth_country","nationality",
  "address","zip_code","city"
].forEach(id=>{
  const el = document.getElementById(id);
  if(!el) return;

  el.addEventListener("input", () => {
    setFieldStateValidated(id);   // ‚úÖ mise √† jour live du trait rouge/vert
    autosave();                   // ‚úÖ sauvegarde diff√©r√©e
  });
});

function formatInputWithCaret(el, formatter){
  if(!el) return;

  const start = el.selectionStart || 0;
  const before =  el.value || "";
  const beforeLen = before.length;

  const after = formatter(before);

  if(after === before) return;

  el.value = after;

  // Ajustement simple du caret (√©vite le ‚Äúsaut‚Äù le plus p√©nible)
  const delta = after.length - beforeLen;
  const newPos = Math.max(0, Math.min(after.length, start + delta));
  try { el.setSelectionRange(newPos, newPos); } catch(e){}
}

// ‚úÖ Formatage en direct pendant la saisie
const secuEl = document.getElementById("carte_vitale");
if(secuEl){
  secuEl.addEventListener("input", ()=>{
    // s√©cu: on reformate propre
    const d = digitsOnly(secuEl.value).slice(0, 15);
    secuEl.value = formatSecuDisplay(d);
  });
}

const preEl = document.getElementById("pre_number");
if(preEl){
  preEl.addEventListener("input", ()=>{
    formatInputWithCaret(preEl, formatPreCarDisplay);
  });
}

  // premier passage pour mettre rouge/‚úÖ d√®s l'ouverture
  window.addEventListener("load", ()=>{
  setFieldStateValidated("carte_vitale");
  setFieldStateValidated("pre_number");
  setFieldStateValidated("birth_date");
  setFieldStateValidated("birth_city");
  setFieldStateValidated("birth_country");
  setFieldStateValidated("nationality");
  setFieldStateValidated("address");
  setFieldStateValidated("zip_code");
  setFieldStateValidated("city");


  });

// Format S√©cu : 15 chiffres (on affiche avec espaces pour lecture)
function formatSecuDisplay(digits){
  // 15 digits: 1 85 12 34 567 890 12
  const parts = [
    digits.slice(0,1),
    digits.slice(1,3),
    digits.slice(3,5),
    digits.slice(5,7),
    digits.slice(7,10),
    digits.slice(10,13),
    digits.slice(13,15),
  ].filter(p => p.length);
  return parts.join(" ");
}


function isValidSecu(digits){
  return digits.length === 15; // simple (on peut faire le vrai contr√¥le cl√© ensuite)
}

// PRE/CAR-083-2025-12-01-20250000000
function isValidPRE(v){
  if(!v) return false;
  return /^(PRE|CAR)-\d{3}-\d{4}-\d{2}-\d{2}-\d{11,}$/.test(v);
}

function applyFormatting(){
  const secu = document.getElementById("carte_vitale");
  if(secu){
    const d = digitsOnly(secu.value);
    secu.value = formatSecuDisplay(d).slice(0, 23); // limite visuelle
  }

  const pre = document.getElementById("pre_number");
  if(pre){
    pre.value = normalizePRE(pre.value);
  }
}

function setFieldStateValidated(inputId){
  const input = document.getElementById(inputId);
  const ok = document.getElementById("ok_" + inputId);
  const wrapper = input?.closest(".field");
  if(!input || !ok || !wrapper) return;

  const raw = (input.value || "").trim();
  let valid = raw.length > 0;

  if(inputId === "carte_vitale"){
    valid = isValidSecu(digitsOnly(raw));
  }
  if(inputId === "pre_number"){
    valid = isValidPRE(normalizePRE(raw));
  }

  if(valid){
    input.style.borderColor = "#bbf7d0";
    ok.textContent = "‚úÖ";
    ok.style.color = "#16a34a";
    wrapper.style.borderLeft = "4px solid #16a34a";   // ‚úÖ IMPORTANT
  }else{
    input.style.borderColor = "#fecdd3";
    ok.textContent = "‚ö†Ô∏è √Ä compl√©ter";
    ok.style.color = "#dc2626";
    wrapper.style.borderLeft = "4px solid #dc2626";   // ‚úÖ IMPORTANT
  }
}

 

  // ========= PHOTO confirmation (exemple) =========
function cancelPhotoUpload(){
  const hint = document.getElementById("photo_hint_photo");
  if(hint) hint.style.display = "none";
  const form = document.getElementById("upload_photo");
  if(form) form.dataset.confirmed = "";
}

function confirmPhotoUpload(){
  const form = document.getElementById("upload_photo");
  if(form){
    form.dataset.confirmed = "1";
    form.submit();
  }
}

window.addEventListener("DOMContentLoaded", ()=>{
  const form = document.getElementById("upload_photo");
  if(!form) return;

  form.addEventListener("submit", (e)=>{
    if(form.dataset.confirmed === "1") return;

    const input = form.querySelector('input[type="file"]');
    if(input && input.files && input.files.length){
      e.preventDefault();
      const hint = document.getElementById("photo_hint_photo");
      if(hint) hint.style.display = "block";
    }
  });
});
// ========= CARTE D'IDENTIT√â confirmation =========
function cancelIdUpload(){
  const hint = document.getElementById("id_hint_id");
  if(hint) hint.style.display = "none";
  const form = document.getElementById("upload_id");
  if(form) form.dataset.confirmed = "";
}

function confirmIdUpload(){
  const form = document.getElementById("upload_id");
  if(form){
    form.dataset.confirmed = "1";
    form.submit();
  }
}

window.addEventListener("DOMContentLoaded", ()=>{
  const form = document.getElementById("upload_id");
  if(!form) return;

  form.addEventListener("submit", (e)=>{
    if(form.dataset.confirmed === "1") return;

    const input = form.querySelector('input[type="file"]');
    // On affiche la confirmation seulement si l'utilisateur a choisi des fichiers
    if(input && input.files && input.files.length){
      e.preventDefault();
      const hint = document.getElementById("id_hint_id");
      if(hint) hint.style.display = "block";
    }
  });
});

  // ====== UX upload : cacher input + bouton d√®s submit ======
window.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll("form.upload-form").forEach(form => {
    form.addEventListener("submit", (e) => {
      // Si on est sur un form avec confirmation (photo/id) et que pas confirm√©, on ne masque rien
      if ((form.id === "upload_photo" || form.id === "upload_id") && form.dataset.confirmed !== "1") {
        return;
      }

      const fileInput = form.querySelector('input[type="file"]');
      const btn = form.querySelector('button[type="submit"]');
      if (fileInput) fileInput.style.display = "none";
      if (btn) btn.style.display = "none";

      const msg = form.querySelector(".uploading-msg");
      if (msg) msg.style.display = "block";
    });
  });
});

document.addEventListener("DOMContentLoaded", () => {
  const cb = document.getElementById("no_permis_checkbox");
  if (!cb) return;

  cb.addEventListener("change", async () => {
    const r = await fetch(`/espace/${token}/infos/update`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        no_permis: cb.checked
      })
    });

    if (!r.ok) {
      alert("Erreur lors de l‚Äôenregistrement du choix.");
    }
  });
});


// --- PRE/CAR live formatter ---
// attendu : PRE-083-2025-12-01-20250000000 (11+ digits √† la fin)
function formatPreCarDisplay(raw){
  let s = (raw || "").toString().toUpperCase();

  // on garde lettres + chiffres uniquement (on vire tirets/espaces/underscore/etc)
  s = s.replace(/[^A-Z0-9]/g, "");

  // prefix
  let prefix = "";
  if (s.startsWith("PRE")) { prefix = "PRE"; s = s.slice(3); }
  else if (s.startsWith("CAR")) { prefix = "CAR"; s = s.slice(3); }
  else {
    // si l'utilisateur tape P/R/E ou C/A/R au d√©but, on tente de deviner
    if (s.startsWith("P")) { prefix = "PRE"; s = s.replace(/^P+/, ""); }
    else if (s.startsWith("C")) { prefix = "CAR"; s = s.replace(/^C+/, ""); }
  }

  // maintenant s = uniquement digits (ou m√©lange si l'utilisateur a fait n'importe quoi)
  // on garde seulement les digits
  const d = s.replace(/\D/g, "");

  // segments: 3 - 4 - 2 - 2 - reste(11+)
  const seg1 = d.slice(0, 3);
  const seg2 = d.slice(3, 7);
  const seg3 = d.slice(7, 9);
  const seg4 = d.slice(9, 11);
  const seg5 = d.slice(11); // reste

  // construit en n'ajoutant le tiret que si segment pr√©sent
  const parts = [];
  if (prefix) parts.push(prefix);
  if (seg1) parts.push(seg1);
  if (seg2) parts.push(seg2);
  if (seg3) parts.push(seg3);
  if (seg4) parts.push(seg4);
  if (seg5) parts.push(seg5);

  return parts.join("-");
}

function normalizePRE(s){
  // pour la validation/serveur : on garde le format final propre
  return formatPreCarDisplay(s);
}
</script>
  

  



{% endblock %}
