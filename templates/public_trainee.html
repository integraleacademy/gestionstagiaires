{% extends "base.html" %}
{% block content %}

<style>
  .public-wrap{max-width:1100px;margin:0 auto;padding:18px;}
.public-grid{
  display:grid;
  grid-template-columns:1fr;
  gap:14px;
}
@media(min-width:900px){
  .public-grid{
    grid-template-columns:1fr 1fr;
  }
}

  .card{background:#fff;border:1px solid #e8eef3;border-radius:16px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.03);}
  .card h2{margin:0 0 10px 0;font-size:18px}
  .muted{color:#6b7280;font-size:13px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .line{display:flex;justify-content:space-between;gap:10px;padding:8px 0;border-top:1px dashed #edf2f7}
  .line:first-child{border-top:none;padding-top:0}
  .label{font-weight:800}
  .value{font-weight:700}

  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px;border:1px solid #e5e7eb;background:#f9fafb}
  .pill.red{background:#fff1f2;border-color:#fecdd3;color:#9f1239}
  .pill.orange{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
  .pill.yellow{background:#fefce8;border-color:#fde68a;color:#854d0e}
  .pill.green{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
  .pill.gray{background:#f3f4f6;border-color:#e5e7eb;color:#374151}
  .pill.blue{background:#eff6ff;border-color:#bfdbfe;color:#1d4ed8}

  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border-radius:12px;padding:10px 12px;font-weight:900;border:1px solid #e5e7eb;background:#111827;color:#fff;text-decoration:none;cursor:pointer}
  .btn.outline{background:#fff;color:#111827}
  .btn.small{padding:8px 10px;border-radius:10px;font-size:13px}
  .hint{background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:10px}
  .oktag{font-weight:900;color:#065f46}

  .field{display:flex;flex-direction:column;gap:6px;margin-top:10px}
  .field input{border:1px solid #e5e7eb;border-radius:12px;padding:10px 12px;font-weight:700}
  .saved{font-size:12px;color:#065f46;font-weight:900;display:none}
  .saved.show{display:inline-block}

  .docrow{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;padding:10px 0;border-top:1px dashed #edf2f7}
  .docrow:first-child{border-top:none;padding-top:0}
  .docmeta{display:flex;flex-direction:column;gap:2px}

.docrow.missing{
  border:1px dashed #fecaca;
  background:#fff1f2;
  border-radius:12px;
  padding:10px;
}
.docrow.pending{
  border:1px solid #fed7aa;
  background:#fff7ed;
  border-radius:12px;
  padding:10px;
}
  .doctag{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 12px;
    border-radius:999px;
    font-weight:900;
    font-size:12px;
    border:1px solid #e5e7eb;
    background:#fff;
  }
  .doctag.missing{
    border-color:#fecaca;
    color:#b91c1c;
    background:#fff;
  }
  .doctag.pending{
    border-color:#fed7aa;
    color:#9a3412;
    background:#fff;
  }

  /* ‚úÖ √©vite les doubles cadres : on enl√®ve la s√©paration "border-top" quand c‚Äôest missing/pending */
.docrow.missing,
.docrow.pending{
  border-top: none !important;
}

  /* ‚úÖ Page stagiaire : ne pas forcer les file inputs en full width */
.public-wrap input[type="file"]{
  width:auto !important;
  max-width:100% !important;
}

/* ‚úÖ Form upload align√© propre */
.public-wrap .upload-form{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  margin-top:10px;
}

  /* ‚ùå enl√®ve les styles globaux sur .docrow */
/* .public-wrap .docrow{ ... } */
/* .public-wrap .docrow:not(.missing):not(.pending){ ... } */
/* .public-wrap .docrow{ ... } */

/* ‚úÖ styles "cartes" UNIQUEMENT pour Mes documents */
.public-wrap .docs-stack .docrow{
  border-top:none !important;
  border-radius:14px;
}
.public-wrap .docs-stack .docrow:not(.missing):not(.pending){
  background:#f9fafb;
  border:1px solid #e5e7eb;
  padding:14px;
}

  /* =========================
   ‚úÖ MES DOCUMENTS (PROPRE)
   ========================= */

/* stack avec vrai espacement */
.public-wrap .docs-stack{
  display:flex;
  flex-direction:column;
  gap:16px;
  margin-top:12px;
}

/* 1 document = 1 carte verticale */
.public-wrap .docs-stack > .docrow{
  display:flex !important;
  flex-direction:column !important;
  align-items:stretch !important;
  justify-content:flex-start !important;
  gap:10px !important;

  padding:14px !important;
  border-radius:14px !important;

  border-top:none !important;     /* on vire l‚Äôeffet ‚Äúliste‚Äù */
}

/* on √©vite l‚Äôimpression ‚Äútout coll√©‚Äù dans la carte */
.public-wrap .docs-stack .docmeta{
  gap:6px;
}
.public-wrap .docs-stack .doctag{
  margin-top:6px;
}

/* le form upload respire */
.public-wrap .docs-stack .upload-form{
  margin-top:6px;
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}

/* √©vite les cadres qui se chevauchent */
.public-wrap .docs-stack .docrow.missing,
.public-wrap .docs-stack .docrow.pending{
  padding:14px !important;
}
  
</style>

{% set tt = (session.training_type or '')|string|upper %}

{% if 'A3P' in tt %}
  {% set formation_label = "Agent de protection physique des personnes (A3P)" %}
{% elif 'APS' in tt %}
  {% set formation_label = "Agent de pr√©vention et de s√©curit√© (APS)" %}
{% elif 'DIRIGEANT' in tt or 'DESP' in tt %}
  {% set formation_label = "Dirigeant d'entreprise de s√©curit√© (DESP)" %}
{% else %}
  {# fallback : nom de session si tu l‚Äôas, sinon training_type #}
  {% set formation_label = (session.name or session.training_type or "‚Äî") %}
{% endif %}


{# helpers de couleur pour statuts #}
{% macro pill_for(kind, value) %}
  {% set v = (value or '') %}
  {% set u = v|string %}
  {% set up = u.upper() %}
  {% set cls = 'gray' %}

  {# Convention #}
  {% if kind=='convention' %}
    {% if v=='signed' %}{% set cls='green' %}
    {% elif v=='signing' %}{% set cls='yellow' %}
    {% else %}{% set cls='red' %}{% endif %}
  {% endif %}

  {# Dossier #}
  {% if kind=='dossier' %}
    {% if v=='complete' %}{% set cls='green' %}
    {% else %}{% set cls='red' %}{% endif %}
  {% endif %}

  {# Test FR #}
  {% if kind=='test_fr' %}
    {% if v=='validated' %}{% set cls='green' %}
    {% elif v=='relance' %}{% set cls='orange' %}
    {% elif v=='in_progress' %}{% set cls='yellow' %}
    {% else %}{% set cls='red' %}{% endif %}
  {% endif %}

  {# Financement #}
  {% if kind=='financement' %}
    {% if v=='validated' %}{% set cls='green' %}
    {% elif v=='in_review' %}{% set cls='yellow' %}
    {% else %}{% set cls='red' %}{% endif %}
  {% endif %}

  {# H√©bergement #}
  {% if kind=='hosting' %}
    {% if v=='reserved' %}{% set cls='green' %}
    {% else %}{% set cls='red' %}{% endif %}
  {% endif %}

  {# CNAPS #}
  {% if kind=='cnaps' %}
    {% if up in ['DELIVREE','D√âLIVR√âE','VALIDE','VALIDEE','VALID√âE'] %}{% set cls='green' %}
    {% elif up in ['INSTRUCTION','EN INSTRUCTION','EN_INSTRUCTION'] %}{% set cls='yellow' %}
    {% elif up in ['REFUSEE','REFUS√âE','EXPIREE','EXPIR√âE'] %}{% set cls='red' %}
    {% else %}{% set cls='gray' %}{% endif %}
  {% endif %}

{# texte affich√© #}
{% set text = u if u else '‚Äî' %}

{# Convention #}
{% if kind=='convention' %}
  {% if v=='signed' %}{% set text='SIGN√âE' %}
  {% elif v=='signing' %}{% set text='EN COURS DE SIGNATURE' %}
  {% else %}{% set text='PROCHAINEMENT' %}{% endif %}
{% endif %}

{# Dossier #}
{% if kind=='dossier' %}
  {% if v=='complete' %}{% set text='COMPLET' %}
  {% else %}{% set text='INCOMPLET' %}{% endif %}
{% endif %}

{# Test FR #}
{% if kind=='test_fr' %}
  {% if v=='validated' %}{% set text='VALID√â' %}
  {% elif v=='relance' %}{% set text='RELANC√â' %}
  {% elif v=='in_progress' %}{% set text='EN COURS' %}
  {% else %}{% set text='PROCHAINEMENT' %}{% endif %}
{% endif %}

{# Financement #}
{% if kind=='financement' %}
  {% if v=='validated' %}{% set text='VALID√â' %}
  {% elif v=='in_review' %}{% set text='EN COURS' %}
  {% else %}{% set text='PROCHAINEMENT' %}{% endif %}
{% endif %}

{# H√©bergement #}
{% if kind=='hosting' %}
  {% if v=='reserved' %}{% set text='R√âSERV√â' %}
  {% else %}{% set text='INCONNU' %}{% endif %}
{% endif %}

{# CNAPS #}
{% if kind=='cnaps' %}
  {% if up in ['DELIVREE','D√âLIVR√âE','VALIDE','VALIDEE','VALID√âE'] %}{% set cls='green' %}
  {% elif up in ['INSTRUCTION','EN INSTRUCTION','EN_INSTRUCTION'] %}{% set cls='yellow' %}
  {% elif up in ['REFUSEE','REFUS√âE','EXPIREE','EXPIR√âE'] %}{% set cls='red' %}
  {% elif up in ['INCONNU','UNKNOWN',''] %}{% set cls='red' %}
  {% else %}{% set cls='gray' %}{% endif %}
{% endif %}


<span class="pill {{cls}}">
  {{ text }}
</span>

{% endmacro %}

<div class="public-wrap">
  <div class="row" style="justify-content:space-between;margin-bottom:10px;">
    <div>
      <div style="font-size:26px;font-weight:1000;">Espace stagiaire</div>
      <div class="muted">Vos informations et documents ‚Äî Int√©grale Academy</div>
    </div>
  </div>

  <div class="public-grid">

    <!-- Encadr√© 1 : infos g√©n√©rales -->
    <div class="card">
      <h2>Infos g√©n√©rales</h2>

      <div class="line">
        <div class="label">Nom</div>
        <div class="value">{{ (trainee.last_name or '')|upper }}</div>
      </div>
      <div class="line">
        <div class="label">Pr√©nom</div>
        <div class="value">{{ (trainee.first_name or '')|upper }}</div>
      </div>
      <div class="line">
  <div class="label">Formation</div>
  <div class="value">{{ formation_label }}</div>
</div>
      <div class="line">
  <div class="label">Type</div>
  <div class="value">{{ session.training_type }}</div>
</div>


      <div class="line">
        <div class="label">Dates de formation</div>
        <div class="value">{{ session.date_start|frdate }} ‚Üí {{ session.date_end|frdate }}</div>
      </div>
      <div class="line">
        <div class="label">Date d‚Äôexamen</div>
        <div class="value">{{ session.exam_date|frdate }}</div>
      </div>
    </div>

    <!-- Encadr√© 2 : suivi de dossier -->
    <div class="card">
      <h2>Suivi de dossier</h2>

      <div class="docrow">
  <div class="docmeta"><div class="label">Inscription valid√©e</div></div>
  <span class="pill green">‚úÖ VALID√âE</span>
</div>


      <div class="docrow">
        <div class="docmeta"><div class="label">Convention de formation</div></div>
        {{ pill_for('convention', trainee.convention_status) }}
      </div>

      <div class="docrow">
        <div class="docmeta"><div class="label">Dossier</div></div>
        {{ pill_for('dossier', 'complete' if dossier_ok else 'incomplete') }}
      </div>

      <div class="docrow">
        <div class="docmeta"><div class="label">CNAPS</div></div>
        {{ pill_for('cnaps', trainee.cnaps) }}
      </div>

      <div class="docrow">
        <div class="docmeta"><div class="label">Test de fran√ßais</div></div>
        {{ pill_for('test_fr', trainee.test_fr_status) }}
      </div>

      <div class="docrow">
        <div class="docmeta"><div class="label">Financement</div></div>
        {{ pill_for('financement', trainee.financement_status) }}
      </div>

      {% if show_hosting %}
        <div class="docrow">
          <div class="docmeta"><div class="label">H√©bergement</div></div>
          {{ pill_for('hosting', trainee.hosting_status) }}
        </div>

        {% if (trainee.hosting_status or 'unknown') == 'unknown' %}
          <div class="hint">
            <div style="font-weight:900;margin-bottom:6px;">H√©bergement non r√©serv√©</div>
            Pour r√©server l‚Äôh√©bergement :
            <a class="btn outline small" target="_blank" href="https://assistance-alw9.onrender.com/hebergement">Cliquez ici</a>
          </div>
        {% endif %}
      {% endif %}
    </div>

    {% if not trainee.public_hide_infos %}
<!-- Encadr√© : infos √† compl√©ter (autosave) -->
<div class="card" style="grid-column:1/-1;">
  <h2>Infos √† compl√©ter</h2>
<div class="muted" style="margin-bottom:10px;">
  ‚úÖ <strong>Tout ce que vous saisissez est enregistr√© automatiquement.</strong><br>
  ‚ö†Ô∏è Ces informations sont <strong>obligatoires</strong>.
  Quand un champ est incomplet, il appara√Æt en <span style="color:#b91c1c;font-weight:900;">rouge</span>.
</div>

{% macro field(label, id, value, placeholder) %}
  {% set ok = value and value|length > 3 %}
  <div class="field" style="border-left:4px solid {{ '#16a34a' if ok else '#dc2626' }};padding-left:10px;">
    <label class="label">{{ label }}</label>

    <div style="display:flex;gap:10px;align-items:center;">
      <input id="{{ id }}" value="{{ value or '' }}" placeholder="{{ placeholder }}" style="flex:1;">
      <span id="ok_{{ id }}" class="saved show" style="min-width:110px;text-align:right;{% if ok %}color:#16a34a;{% else %}color:#dc2626;{% endif %}">
        {% if ok %}‚úÖ{% else %}‚ö†Ô∏è √Ä compl√©ter{% endif %}
      </span>
    </div>
  </div>
{% endmacro %}


  {{ field("Num√©ro de s√©curit√© sociale",
           "carte_vitale",
           trainee.carte_vitale,
           "Ex : 1 85 12 34 567 890 12") }}

{{ field("Num√©ro PRE ou CAR (num√©ro d'autorisation pr√©alable CNAPS qui commence par PRE ou num√©ro de carte professionnelle CNAPS qui commence par CAR)",
         "pre_number",
         trainee.pre_number,
         "Ex : PRE-2025-01-01-20210000000 ou CAR-2025-01-01-20210000000") }}

{# Date de naissance (type date) #}
<div class="field" style="border-left:4px solid {{ '#16a34a' if (trainee.birth_date or '') else '#dc2626' }};padding-left:10px;">
  <label class="label">Date de naissance</label>

  <div style="display:flex;gap:10px;align-items:center;">
    <input id="birth_date"
           type="date"
           value="{{ trainee.birth_date or '' }}"
           style="flex:1;">
    <span id="ok_birth_date" class="saved show" style="min-width:110px;text-align:right;{% if (trainee.birth_date or '') %}color:#16a34a;{% else %}color:#dc2626;{% endif %}">
      {% if (trainee.birth_date or '') %}‚úÖ{% else %}‚ö†Ô∏è √Ä compl√©ter{% endif %}
    </span>
  </div>
</div>

  {{ field("Ville de naissance",
           "birth_city",
           trainee.birth_city,
           "Ex : Marseille") }}

  {{ field("Pays de naissance",
           "birth_country",
           trainee.birth_country,
           "Ex : France") }}

  {{ field("Nationalit√©",
           "nationality",
           trainee.nationality,
           "Ex : Fran√ßaise") }}

  {{ field("Adresse postale",
           "address",
           trainee.address,
           "Ex : 12 rue de la R√©publique") }}

  {{ field("Code postal",
           "zip_code",
           trainee.zip_code,
           "Ex : 75001") }}

  {{ field("Ville",
           "city",
           trainee.city,
           "Ex : Paris") }}
</div>

    </div>

    <!-- Encadr√© STATUT VAE (si DIRIGEANT VAE) -->
    {% if show_vae %}
    <div class="card">
      <h2>Statut VAE</h2>
      <div class="muted">Lecture seule (mis √† jour par l‚Äôadministration).</div>

      {% set v = trainee.vae_status or '' %}
      <div class="row" style="margin-top:10px;">
        <span class="pill blue">Statut : {{ v if v else '‚Äî' }}</span>
      </div>
    </div>
    {% endif %}
  {% endif %}


  {% if not trainee.public_hide_docs %}
  
<!-- Encadr√© 3 : mes documents (upload) -->
<div class="card" style="grid-column:1/-1;">
  <h2>Mes documents</h2>
  <div class="muted">D√©posez ici vos documents.</div>

  <div class="docs-stack">

  {% for d in (trainee.documents or []) %}
{% set has_file = false %}
{% if d %}
  {% if d.files is defined and d.files is sequence and (d.files|length) > 0 %}
    {% set has_file = true %}
  {% elif d.file %}
    {% set has_file = true %}
  {% endif %}
{% endif %}
    {% set st = (d.status if d and d.status else ("NON D√âPOS√â" if not has_file else "A CONTR√îLER")) %}
    {% set up = (st|string)|upper %}
  {% set can_replace = (has_file and up == "NON CONFORME") %}
{% set show_upload = ((not has_file) or can_replace) and not (d.key == "permis" and trainee.no_permis) %}

    {% set row_cls = "missing" %}
    {% if has_file %}
      {% if up == "CONFORME" %}
        {% set row_cls = "" %}
      {% elif up == "NON CONFORME" %}
        {% set row_cls = "missing" %}
      {% else %}
        {% set row_cls = "pending" %}
      {% endif %}
    {% endif %}

    {% set accept = (d.accept or "") %}
    {% set hint = "Fichier" %}
    {% if "application/pdf" in accept %}
      {% set hint = "PDF uniquement" %}
    {% elif "image/" in accept %}
      {% set hint = "JPEG ou PNG" %}
    {% endif %}

<div class="docrow {{ row_cls }}" id="doc_{{ d.key }}">
      <div class="docmeta">
        <div class="label">{{ d.label }}</div>
        {% if d.key == "permis" %}
  <label style="margin-top:8px;display:flex;align-items:center;gap:8px;font-weight:800;">
    <input
      type="checkbox"
      id="no_permis_checkbox"
      {% if trainee.no_permis %}checked{% endif %}
    >
    Je n‚Äôai pas le permis de conduire
  </label>

  <div class="muted" style="margin-top:4px;">
    Si vous cochez cette case, le d√©p√¥t du permis n‚Äôest pas obligatoire.
  </div>
{% endif %}

        {% if d.key == "permis" and trainee.no_permis %}
  <div class="doctag"
       style="margin-top:8px;border-color:#bbf7d0;color:#065f46;">
    ‚úÖ Permis non requis (d√©clar√©)
  </div>
{% endif %}
        
        <div class="muted">{{ hint }}</div>

{% if not has_file and not (d.key == "permis" and trainee.no_permis) %}
  <div class="doctag missing">üìå Document √† d√©poser (obligatoire)</div>
{% else %}
  {% if has_file %}
    {% if up == "CONFORME" %}
      <div class="doctag" style="border-color:#bbf7d0;color:#065f46;background:#fff;">‚úÖ Document conforme</div>
    {% elif up == "NON CONFORME" %}
      <div class="doctag missing">‚ùå Document non conforme ‚Äî √† remplacer</div>
    {% else %}
      <div class="doctag pending">‚è≥ Document d√©pos√© ‚Äî en attente de contr√¥le</div>
    {% endif %}
  {% endif %}
{% endif %}

{% if show_upload %}
<form class="upload-form"
id="upload_{{ d.key }}"
  action="/espace/{{ token }}/documents/{{ d.key }}/upload"
  method="post"
  enctype="multipart/form-data">

{% if d.key == "id" %}
  <div class="muted" style="font-weight:900;color:#111;margin-bottom:6px;">
    üìå Attention Carte d'identit√© OU Titre de s√©jour :
    <span style="color:#b91c1c;">RECTO + VERSO (vous pouvez d√©poser 1 fichier si votre document contient recto/verso, sinon 2 fichiers)</span>
  </div>

  <input type="file"
         name="file"
         accept="{{ accept }}"
         required>
{% else %}
  <input type="file"
         name="file"
         accept="{{ accept }}"
         {% if not (d.key == "permis" and trainee.no_permis) %}required{% endif %}>
{% endif %}

<button class="btn small" type="submit">
  {% if can_replace %}Remplacer{% else %}D√©poser{% endif %}
</button>

<div class="uploading-msg" style="display:none;margin-top:8px;font-weight:900;">
  ‚è≥ Envoi en cours‚Ä¶
</div>
</form>
{% else %}
  <span class="pill green">üìé Fichier d√©j√† envoy√©</span>
{% endif %}

{% if d.key == "id" %}
  <div id="id_hint_id" style="display:none;margin-top:12px;border:2px solid #fed7aa;background:#fff7ed;padding:12px;border-radius:12px;">
    <div style="font-weight:900;color:#9a3412;margin-bottom:8px;">
      Avez-vous bien fourni votre passeport, ou votre carte d'identit√©
      <span style="color:#b91c1c;">RECTO / VERSO (2 c√¥t√©s)</span> ?
    </div>

    <div style="display:flex;gap:10px;">
      <button type="button" class="btn outline small" onclick="cancelIdUpload()">Modifier</button>
      <button type="button" class="btn small" onclick="confirmIdUpload()">Oui, je confirme</button>
    </div>
  </div>
{% endif %}

{% if d.key == "photo" %}
  <div id="photo_hint_photo" style="display:none;margin-top:12px;border:2px solid #fed7aa;background:#fff7ed;padding:12px;border-radius:12px;">
    <div style="font-weight:900;color:#9a3412;margin-bottom:8px;">
      Avez-vous bien fourni une photo d‚Äôidentit√© conforme ? (photo de face, sur fond neutre). Cette photo appara√Ætra sur votre dipl√¥me.
    </div>

    <img src="/static/photo-exemple.png"
         alt="Exemple photo identit√© conforme"
         style="max-width:240px;width:100%;border-radius:10px;border:1px solid #e5e7eb;display:block;margin-bottom:10px;">

    <div style="display:flex;gap:10px;">
      <button type="button" class="btn outline small" onclick="cancelPhotoUpload()">Modifier</button>
      <button type="button" class="btn small" onclick="confirmPhotoUpload()">Oui, je confirme</button>
    </div>
  </div>
{% endif %}
      </div>  <!-- ferme .docmeta -->
    </div>    <!-- ferme .docrow -->
  {% endfor %}
  
</div>
    </div>

  {% endif %}
    <!-- Encadr√© 4 : dipl√¥mes et attestations -->
    <div class="card" style="grid-column:1/-1;">
      <h2>Mes dipl√¥mes et attestations</h2>



    {% set deliv = trainee.deliverables or {} %}

<div class="docrow">
  <div class="docmeta"><div class="label">Ma carte SST</div></div>
  {% if deliv.get('carte_sst') %}
    <a class="btn outline small" target="_blank"
       href="/admin/uploads/{{ deliv.get('carte_sst') }}">Voir</a>
  {% else %}
    <span class="pill gray">Prochainement</span>
  {% endif %}
</div>

<div class="docrow">
  <div class="docmeta"><div class="label">Mon dipl√¥me</div></div>
  {% if deliv.get('diplome') %}
    <a class="btn outline small" target="_blank"
       href="/admin/uploads/{{ deliv.get('diplome') }}">Voir</a>
  {% else %}
    <span class="pill gray">Prochainement</span>
  {% endif %}
</div>

<div class="docrow">
  <div class="docmeta"><div class="label">Mes attestations de fin de formation</div></div>
  {% if deliv.get('attestation_fin_formation') %}
    <a class="btn outline small" target="_blank"
       href="/admin/uploads/{{ deliv.get('attestation_fin_formation') }}">Voir</a>
  {% else %}
    <span class="pill gray">Prochainement</span>
  {% endif %}
</div>

    </div>

  </div>
</div>

<!-- ‚úÖ Welcome popup (plus joli, affich√© une seule fois) -->
<style>
  /* Backdrop */
.ia-modal-backdrop{
  position:fixed; inset:0;
  display:flex;                 /* ‚úÖ toujours flex */
  align-items:center;           /* ‚úÖ centr√© vertical */
  justify-content:center;       /* ‚úÖ centr√© horizontal */
  background:rgba(15,23,42,.55);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  z-index:9999;
  padding:18px;

  /* ‚úÖ cach√© par d√©faut */
  opacity:0;
  visibility:hidden;
  pointer-events:none;
  transition: opacity .15s ease;
}
.ia-modal-backdrop.show{
  opacity:1;
  visibility:visible;
  pointer-events:auto;
}


  /* Modal */
.ia-modal{
  width:min(780px, 100%);
  max-height: calc(100vh - 36px);
  overflow:auto;
  background:#fff;
  border-radius:22px;
  border:1px solid #e5e7eb;
  box-shadow:0 25px 70px rgba(0,0,0,.25);
  transform: translateY(6px);
  animation: iaPop .18s ease-out forwards;
}
  @keyframes iaPop{to{transform: translateY(0)}}

  /* Top accent */
  .ia-accent{
    height:6px;
    background: linear-gradient(90deg, #F4C45A, #111827);
  }

  /* Header */
  .ia-head{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    padding:18px 18px 10px 18px;
  }
  .ia-brand{
    display:flex;
    gap:12px;
    align-items:center;
  }
.ia-logo{
  width:72px;
  height:72px;
  border-radius:16px;
  border:1px solid #e5e7eb;
  background:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
.ia-logo img{
  width:100%;
  height:100%;
  object-fit:contain;   /* ‚úÖ pas de d√©coupe */
  display:block;
  padding:8px;          /* ‚úÖ respiration */
}
  .ia-title{
    font-size:20px;
    font-weight:1000;
    margin:0;
    color:#0f172a;
    line-height:1.15;
  }
  .ia-sub{
    margin-top:4px;
    font-weight:800;
    color:#475569;
    font-size:13px;
  }

  /* Close button */
  .ia-close{
    border:1px solid #e5e7eb;
    background:#fff;
    width:40px;height:40px;
    border-radius:12px;
    cursor:pointer;
    font-weight:1000;
    color:#0f172a;
  }
  .ia-close:hover{background:#f8fafc}

  /* Body */
  .ia-body{padding:8px 18px 18px 18px;}
  .ia-card{
    border:1px solid #e5e7eb;
    background:#f8fafc;
    border-radius:16px;
    padding:14px;
  }
  .ia-p{
    margin:0;
    color:#0f172a;
    font-size:14px;
    line-height:1.5;
    font-weight:700;
  }
  .ia-p + .ia-p{margin-top:10px;}
  .ia-badge{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid #fde68a;
    background:#fefce8;
    color:#854d0e;
    font-weight:1000;
    font-size:12px;
    margin-top:12px;
  }

  /* Footer */
  .ia-foot{
    display:flex;
    justify-content:flex-end;
    gap:10px;
    padding:14px 18px 18px 18px;
    border-top:1px solid #eef2f7;
    background:#fff;
  }
</style>

<div id="welcomeModal" class="ia-modal-backdrop">
  <div class="ia-modal" role="dialog" aria-modal="true" aria-labelledby="welcomeTitle">
    <div class="ia-accent"></div>

    <div class="ia-head">
      <div class="ia-brand">
        <div class="ia-logo">
          <img src="{{ url_for('static', filename='logo-integrale.png') }}" alt="Int√©grale Academy">
        </div>

        <div>
          <div id="welcomeTitle" class="ia-title">
            Bonjour {{ (trainee.first_name or '')|title }},
          </div>
          <div class="ia-sub">
            Bienvenue dans votre Espace Stagiaire Int√©grale Academy.
          </div>
        </div>
      </div>

      <button type="button" class="ia-close" data-close-modal="welcomeModal" aria-label="Fermer">‚úï</button>
    </div>

    <div class="ia-body">
      <div class="ia-card">
        <p class="ia-p">
          Vous devez √† pr√©sent compl√©ter vos informations personnelles et d√©poser vos documents obligatoires.
          Pour un meilleur traitement de votre dossier, merci de r√©aliser cette √©tape d√®s que possible
          et au plus tard <strong>10 jours avant</strong> votre entr√©e en formation.
        </p>

        <p class="ia-p">
          ‚úÖ √Ä l‚Äôissue de votre formation, vous retrouverez dans votre <strong>Espace Stagiaire</strong> vos
          <strong>dipl√¥mes</strong> et <strong>attestations</strong>.
        </p>

        <p class="ia-p" style="margin-top:12px;">
          Merci par avance,<br>
          <strong>La Team Int√©grale Academy</strong>
        </p>
      </div>
    </div>

    <div class="ia-foot">
      <button type="button" class="btn" data-close-modal="welcomeModal">J‚Äôai compris</button>
    </div>
  </div>
</div>

<!-- ‚úÖ Popup confirmation d√©p√¥t document -->
<div id="uploadSuccessModal" class="ia-modal-backdrop">
  <div class="ia-modal" role="dialog" aria-modal="true">
    <div class="ia-accent"></div>

    <div class="ia-head">
      <div class="ia-brand">
        <div class="ia-logo">
          <img src="{{ url_for('static', filename='logo-integrale.png') }}" alt="Int√©grale Academy">
        </div>
        <div>
          <div class="ia-title">Document d√©pos√© avec succ√®s</div>
          <div class="ia-sub">Merci pour votre envoi</div>
        </div>
      </div>

      <button type="button" class="ia-close" onclick="closeModal('uploadSuccessModal')">‚úï</button>
    </div>

    <div class="ia-body">
      <div class="ia-card">
        <p class="ia-p">
          ‚úÖ Votre document <strong id="uploadedFileName"></strong> a bien √©t√© d√©pos√©.
        </p>
        <p class="ia-p">
          Notre √©quipe va proc√©der √† un contr√¥le de votre document afin de s‚Äôassurer de sa conformit√©.
        </p>
      </div>
    </div>

    <div class="ia-foot">
      <button class="btn" onclick="closeModal('uploadSuccessModal')">
        D√©poser mes autres documents
      </button>
    </div>
  </div>
</div>


<script>

  
// üîß Fallback open/close pour le nouveau popup IA (si base.html ne g√®re pas ia-modal-backdrop)
if (typeof openModal !== "function") {
  window.openModal = (id) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.add("show"); // ‚úÖ
  };
}

if (typeof closeModal !== "function") {
  window.closeModal = (id) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.remove("show"); // ‚úÖ
  };
}
  const token = "{{ token }}";
// ‚úÖ Welcome popup ‚Äî une seule fois par stagiaire (token)
(function(){
  const seenKey = "ia_welcome_seen_" + token;

  document.addEventListener("DOMContentLoaded", () => {
    let seen = false;
    try { seen = localStorage.getItem(seenKey) === "1"; } catch(e){}

    if(!seen){
      // openModal() vient de base.html
      openModal("welcomeModal");
    }

    // Quand on ferme => on marque vu
    const modal = document.getElementById("welcomeModal");
    if(!modal) return;

    const markSeen = () => { try { localStorage.setItem(seenKey, "1"); } catch(e){} };

    modal.querySelectorAll('[data-close-modal="welcomeModal"]').forEach(btn=>{
      btn.addEventListener("click", markSeen);
    });

    // clic sur le fond
    modal.addEventListener("click", (e)=>{
      if(e.target === modal){
        closeModal("welcomeModal");
        markSeen();
      }
    });
  });
})();


  // ‚úÖ Helpers formatage live
function digitsOnly(s){
  return (s || "").toString().replace(/\D+/g, "");
}


function applyFormattingLive(){
  // S√©cu
  const secu = document.getElementById("carte_vitale");
  if(secu){
    const d = digitsOnly(secu.value).slice(0, 15);
    secu.value = formatSecuDisplay(d);
  }

  // PRE
  const pre = document.getElementById("pre_number");
  if(pre){
    pre.value = normalizePRE(pre.value);
  }
}

  function flashSaved(id){
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.add("show");
    setTimeout(()=>el.classList.remove("show"), 1200);
  }

function setFieldState(inputId){
  const input = document.getElementById(inputId);
  const ok = document.getElementById("ok_" + inputId);
  const wrapper = input?.closest(".field"); // üëà LA CL√â EST L√Ä
  if(!input || !ok || !wrapper) return;

  const v = (input.value || "").trim();
  const valid = v.length > 0;

  if(valid){
    input.style.borderColor = "#bbf7d0";
    ok.textContent = "‚úÖ";
    ok.style.color = "#16a34a";
    wrapper.style.borderLeft = "4px solid #16a34a"; // üü¢ LIVE
  }else{
    input.style.borderColor = "#fecdd3";
    ok.textContent = "‚ö†Ô∏è √Ä compl√©ter";
    ok.style.color = "#dc2626";
    wrapper.style.borderLeft = "4px solid #dc2626"; // üî¥ LIVE
  }
}



  let tmr = null;
  function autosave(){
    clearTimeout(tmr);
    tmr = setTimeout(async ()=>{

      const carte_vitale  = document.getElementById("carte_vitale")?.value || "";
      const pre_number    = document.getElementById("pre_number")?.value || "";

      const birth_date    = document.getElementById("birth_date")?.value || "";
      const birth_city    = document.getElementById("birth_city")?.value || "";
      const birth_country = document.getElementById("birth_country")?.value || "";
      const nationality   = document.getElementById("nationality")?.value || "";

      const address       = document.getElementById("address")?.value || "";
      const zip_code      = document.getElementById("zip_code")?.value || "";
      const city          = document.getElementById("city")?.value || "";

      applyFormatting();
      const r = await fetch(`/espace/${token}/infos/update`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          carte_vitale, pre_number,
          birth_date, birth_city, birth_country, nationality,
          address, zip_code, city
        })
      });

      if(r.ok){
        // ‚úÖ feedback minimal: on montre que c'est enregistr√©
        flashSaved("ok_carte_vitale");
        flashSaved("ok_pre_number");

        // ‚úÖ √©tat ‚Äú√† compl√©ter / ok‚Äù (on le fera joli apr√®s)
        setFieldStateValidated("carte_vitale");
        setFieldStateValidated("pre_number");
        setFieldStateValidated("birth_date");
        setFieldStateValidated("birth_city");
        setFieldStateValidated("birth_country");
        setFieldStateValidated("nationality");
        setFieldStateValidated("address");
        setFieldStateValidated("zip_code");
        setFieldStateValidated("city");


      }
    }, 400);
  }

  // listeners existants (garde-les si tu veux) + nouveaux
  [
  "carte_vitale","pre_number",
  "birth_date","birth_city","birth_country","nationality",
  "address","zip_code","city"
].forEach(id=>{
  const el = document.getElementById(id);
  if(!el) return;

  el.addEventListener("input", () => {
    setFieldStateValidated(id);   // ‚úÖ mise √† jour live du trait rouge/vert
    autosave();                   // ‚úÖ sauvegarde diff√©r√©e
  });
});

function formatInputWithCaret(el, formatter){
  if(!el) return;

  const start = el.selectionStart || 0;
  const before =  el.value || "";
  const beforeLen = before.length;

  const after = formatter(before);

  if(after === before) return;

  el.value = after;

  // Ajustement simple du caret (√©vite le ‚Äúsaut‚Äù le plus p√©nible)
  const delta = after.length - beforeLen;
  const newPos = Math.max(0, Math.min(after.length, start + delta));
  try { el.setSelectionRange(newPos, newPos); } catch(e){}
}

// ‚úÖ Formatage en direct pendant la saisie
const secuEl = document.getElementById("carte_vitale");
if(secuEl){
  secuEl.addEventListener("input", ()=>{
    // s√©cu: on reformate propre
    const d = digitsOnly(secuEl.value).slice(0, 15);
    secuEl.value = formatSecuDisplay(d);
  });
}

const preEl = document.getElementById("pre_number");
if(preEl){
  preEl.addEventListener("input", ()=>{
    formatInputWithCaret(preEl, formatPreCarDisplay);
  });
}

  // premier passage pour mettre rouge/‚úÖ d√®s l'ouverture
  window.addEventListener("load", ()=>{
  setFieldStateValidated("carte_vitale");
  setFieldStateValidated("pre_number");
  setFieldStateValidated("birth_date");
  setFieldStateValidated("birth_city");
  setFieldStateValidated("birth_country");
  setFieldStateValidated("nationality");
  setFieldStateValidated("address");
  setFieldStateValidated("zip_code");
  setFieldStateValidated("city");


  });

// Format S√©cu : 15 chiffres (on affiche avec espaces pour lecture)
function formatSecuDisplay(digits){
  // 15 digits: 1 85 12 34 567 890 12
  const parts = [
    digits.slice(0,1),
    digits.slice(1,3),
    digits.slice(3,5),
    digits.slice(5,7),
    digits.slice(7,10),
    digits.slice(10,13),
    digits.slice(13,15),
  ].filter(p => p.length);
  return parts.join(" ");
}


function isValidSecu(digits){
  return digits.length === 15; // simple (on peut faire le vrai contr√¥le cl√© ensuite)
}

// PRE/CAR-083-2025-12-01-20250000000
function isValidPRE(v){
  if(!v) return false;
  return /^(PRE|CAR)-\d{3}-\d{4}-\d{2}-\d{2}-\d{11,}$/.test(v);
}

function applyFormatting(){
  const secu = document.getElementById("carte_vitale");
  if(secu){
    const d = digitsOnly(secu.value);
    secu.value = formatSecuDisplay(d).slice(0, 23); // limite visuelle
  }

  const pre = document.getElementById("pre_number");
  if(pre){
    pre.value = normalizePRE(pre.value);
  }
}

function setFieldStateValidated(inputId){
  const input = document.getElementById(inputId);
  const ok = document.getElementById("ok_" + inputId);
  const wrapper = input?.closest(".field");
  if(!input || !ok || !wrapper) return;

  const raw = (input.value || "").trim();
  let valid = raw.length > 0;

  if(inputId === "carte_vitale"){
    valid = isValidSecu(digitsOnly(raw));
  }
  if(inputId === "pre_number"){
    valid = isValidPRE(normalizePRE(raw));
  }

  if(valid){
    input.style.borderColor = "#bbf7d0";
    ok.textContent = "‚úÖ";
    ok.style.color = "#16a34a";
    wrapper.style.borderLeft = "4px solid #16a34a";   // ‚úÖ IMPORTANT
  }else{
    input.style.borderColor = "#fecdd3";
    ok.textContent = "‚ö†Ô∏è √Ä compl√©ter";
    ok.style.color = "#dc2626";
    wrapper.style.borderLeft = "4px solid #dc2626";   // ‚úÖ IMPORTANT
  }
}

 

  // ========= PHOTO confirmation (exemple) =========
function cancelPhotoUpload(){
  const hint = document.getElementById("photo_hint_photo");
  if(hint) hint.style.display = "none";
  const form = document.getElementById("upload_photo");
  if(form) form.dataset.confirmed = "";
}

function confirmPhotoUpload(){
  const form = document.getElementById("upload_photo");
  if(form){
    form.dataset.confirmed = "1";
    form.submit();
  }
}

window.addEventListener("DOMContentLoaded", ()=>{
  const form = document.getElementById("upload_photo");
  if(!form) return;

  form.addEventListener("submit", (e)=>{
    if(form.dataset.confirmed === "1") return;

    const input = form.querySelector('input[type="file"]');
    if(input && input.files && input.files.length){
      e.preventDefault();
      const hint = document.getElementById("photo_hint_photo");
      if(hint) hint.style.display = "block";
    }
  });
});
// ========= CARTE D'IDENTIT√â confirmation =========
function cancelIdUpload(){
  const hint = document.getElementById("id_hint_id");
  if(hint) hint.style.display = "none";
  const form = document.getElementById("upload_id");
  if(form) form.dataset.confirmed = "";
}

function confirmIdUpload(){
  const form = document.getElementById("upload_id");
  if(form){
    form.dataset.confirmed = "1";
    form.submit();
  }
}

window.addEventListener("DOMContentLoaded", ()=>{
  const form = document.getElementById("upload_id");
  if(!form) return;

  form.addEventListener("submit", (e)=>{
    if(form.dataset.confirmed === "1") return;

    const input = form.querySelector('input[type="file"]');
    // On affiche la confirmation seulement si l'utilisateur a choisi des fichiers
    if(input && input.files && input.files.length){
      e.preventDefault();
      const hint = document.getElementById("id_hint_id");
      if(hint) hint.style.display = "block";
    }
  });
});

  // ====== UX upload : cacher input + bouton d√®s submit ======
window.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll("form.upload-form").forEach(form => {
    form.addEventListener("submit", (e) => {
      // Si on est sur un form avec confirmation (photo/id) et que pas confirm√©, on ne masque rien
      if ((form.id === "upload_photo" || form.id === "upload_id") && form.dataset.confirmed !== "1") {
        return;
      }

      const fileInput = form.querySelector('input[type="file"]');
      const btn = form.querySelector('button[type="submit"]');
      if (fileInput) fileInput.style.display = "none";
      if (btn) btn.style.display = "none";

      const msg = form.querySelector(".uploading-msg");
      if (msg) msg.style.display = "block";
    });
  });
});

document.addEventListener("DOMContentLoaded", () => {
  const cb = document.getElementById("no_permis_checkbox");
  if (!cb) return;

  cb.addEventListener("change", async () => {

    // 1Ô∏è‚É£ Sauvegarde backend
    const r = await fetch(`/espace/${token}/infos/update`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        no_permis: cb.checked
      })
    });

    if (!r.ok) {
      alert("Erreur lors de l‚Äôenregistrement du choix.");
      return;
    }

    // 2Ô∏è‚É£ Mise √† jour UI en live (sans refresh)
    const permisRow = document.getElementById("upload_permis")?.closest(".docrow");
    if (!permisRow) return;

    if (cb.checked) {
      // ‚ûú permis non requis
      permisRow.querySelector("form")?.remove();
      permisRow.querySelector(".doctag.missing")?.remove();

      const tag = document.createElement("div");
      tag.className = "doctag";
      tag.style.borderColor = "#bbf7d0";
      tag.style.color = "#065f46";
      tag.style.marginTop = "8px";
      tag.textContent = "‚úÖ Permis non requis (d√©clar√©)";
      permisRow.querySelector(".docmeta")?.appendChild(tag);
    } else {
      // ‚ûú on recharge la page pour revenir √† l‚Äô√©tat initial
      location.reload();
    }
  });
});


// --- PRE/CAR live formatter ---
// attendu : PRE-083-2025-12-01-20250000000 (11+ digits √† la fin)
function formatPreCarDisplay(raw){
  raw = (raw || "").toString().toUpperCase().replace(/\s+/g, "");
  raw = raw.replace(/[^A-Z0-9-]/g, "");

  // prefix PRE ou CAR
  let prefix = "";
  if (raw.startsWith("PRE")) prefix = "PRE";
  else if (raw.startsWith("CAR")) prefix = "CAR";

  // si pas de prefix valide, on laisse l'utilisateur taper (mais on nettoie)
  if (!prefix) return raw.replace(/[^A-Z0-9-]/g, "");

  // r√©cup√®re tous les chiffres apr√®s le prefix
  let digits = raw.slice(3).replace(/\D/g, "");

  // attendu : DDD(3) + YYYY(4) + MM(2) + DD(2) + LAST(11+) => min 22 chiffres
  // on coupe large pour √©viter que √ßa parte en vrille si le stagiaire colle trop long
  digits = digits.slice(0, 3 + 4 + 2 + 2 + 20);

  const dep  = digits.slice(0, 3);
  const y    = digits.slice(3, 7);
  const m    = digits.slice(7, 9);
  const d    = digits.slice(9, 11);
  const last = digits.slice(11); // 11+ chiffres

  let out = prefix;
  if (dep)  out += "-" + dep;
  if (y)    out += "-" + y;
  if (m)    out += "-" + m;
  if (d)    out += "-" + d;
  if (last) out += "-" + last;

  return out;
}

function normalizePRE(s){
  return formatPreCarDisplay(s);
}

(function(){
  const params = new URLSearchParams(window.location.search);
  const uploaded = params.get("uploaded");

  if(uploaded){
    const row = document.getElementById("doc_" + uploaded);

    // 1) Texte de la modale = label du doc
    let label = null;
    if(row){
      const lab = row.querySelector(".docmeta .label");
      if(lab) label = lab.textContent.trim();
    }

    const nameEl = document.getElementById("uploadedFileName");
    if(nameEl){
      nameEl.textContent = label || "votre document";
    }

    // 2) Ouvrir la modale
    openModal("uploadSuccessModal");

    // 3) Scroll sur le doc
    if(row){
      setTimeout(()=>{
        row.scrollIntoView({ behavior:"smooth", block:"center" });
      }, 150);
    }

    // 4) Nettoyer l‚ÄôURL
    const cleanUrl = window.location.pathname;
    window.history.replaceState({}, "", cleanUrl);
  }
})();
</script>
  




{% endblock %}
