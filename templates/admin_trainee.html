{% extends "base.html" %}
{% block content %}

<div class="breadcrumbs">
  <a href="{{ url_for('admin_trainees', session_id=session.id, **request.args) }}">‚Üê Retour stagiaires</a>
</div>

<div class="session-header">
  <div>
    <h1>Fiche stagiaire</h1>
    <div style="margin-top:6px;font-weight:900;color:#dc2626;">
  DEBUG TEMPLATE: admin_trainee.html v2 - {{ session.id }} / {{ trainee.id }}
</div>

    <div class="meta-line">
      <span class="pill">{{ session.training_type }}</span>
      <span>Session : <strong>{{ session.name }}</strong></span>
      <span>Formation : <strong>{{ session.date_start }}</strong> ‚Üí <strong>{{ session.date_end }}</strong></span>
      <span>Examen : <strong>{{ session.exam_date }}</strong></span>
    </div>
  </div>
</div>

<div class="card" style="margin-top:12px;">
  <div class="card-row" style="display:flex;gap:12px;align-items:flex-start;justify-content:space-between;">
    <div>
      <div style="font-size:20px;font-weight:900;">{{ trainee.first_name }} {{ trainee.last_name }}</div>
      <div class="meta-line" style="margin-top:6px;">
        <span class="mono">Email : {{ trainee.email or "‚Äî" }}</span>
        <span class="mono">Tel : {{ trainee.phone or "‚Äî" }}</span>
        <span class="mono">ID : {{ trainee.personal_id or trainee.id }}</span>
      </div>
      <div class="meta-line" style="margin-top:6px;">
{% set c = (trainee.cnaps or "INCONNU")|upper %}

<span class="cnaps
  {% if "TRANSM" in c %}cnaps-transmis
  {% elif "ENREG" in c %}cnaps-enregistre
  {% elif "INSTRU" in c %}cnaps-instruction
  {% elif "ACCEPT" in c %}cnaps-accepte
  {% elif "REFUS" in c %}cnaps-refuse
  {% elif "DOC" in c %}cnaps-docs
  {% else %}cnaps-inconnu
  {% endif %}">
  CNAPS : {{ c }}
</span>

        <button class="mini-btn" id="btnRefreshCnaps" type="button">‚Üª Rafra√Æchir CNAPS</button>
      </div>

      {% if trainee.access_sent_at %}
      <div class="hint" style="margin-top:8px;">‚úÖ Acc√®s envoy√© le : <strong>{{ trainee.access_sent_at }}</strong></div>
      {% endif %}
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
      <form method="post" action="{{ url_for('admin_delete_trainee', session_id=session.id, trainee_id=trainee.id) }}"
            onsubmit="return confirm('Supprimer ce stagiaire ?');">
        <button class="btn btn-danger" type="submit">üóëÔ∏è Supprimer le stagiaire</button>
      </form>

      <a class="btn btn-outline"
         href="{{ url_for('admin_etiquette_docx', session_id=session.id, trainee_id=trainee.id) }}">
        üñ®Ô∏è Imprimer √©tiquette dossier (Word)
      </a>

      <form method="post" action="{{ url_for('admin_send_access', session_id=session.id, trainee_id=trainee.id) }}">
        <button class="btn btn-primary" type="submit">üì© Envoyer acc√®s espace stagiaire</button>
        <a class="btn btn-outline"
   href="{{ PUBLIC_STUDENT_PORTAL_BASE.rstrip('/') }}/espace/{{ trainee.public_token }}"
   target="_blank"
   rel="noopener">
  üëÅÔ∏è Voir espace stagiaire (public)
</a>

      </form>
    </div>
  </div>
</div>


<div class="grid" style="grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px;">

  <!-- ===================== -->
  <!-- TEST DE FRAN√áAIS       -->
  <!-- ===================== -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:900;">Test de fran√ßais</div>
      <div>
{% set tf = (trainee.test_fr_status or "soon") %}
{% set tf_label = ("PROCHAINEMENT" if tf=="soon" else ("EN COURS" if tf=="in_progress" else ("RELANC√â" if tf=="relance" else "VALID√â"))) %}
<span class="pill
  {% if tf=="soon" %}pill-gray
  {% elif tf=="in_progress" %}pill-orange
  {% elif tf=="relance" %}pill-red
  {% else %}pill-green
  {% endif %}">
  Statut : {{ tf_label }}
</span>

      </div>
    </div>

    <div class="hint" style="margin-top:8px;">
      Lien : <a href="https://testb1.lapreventionsecurite.org/Public/" target="_blank">https://testb1.lapreventionsecurite.org/Public/</a>
    </div>

    {% if trainee.test_fr_deadline %}
      <div class="hint" style="margin-top:6px;">√âch√©ance : <strong>{{ trainee.test_fr_deadline }}</strong></div>
    {% endif %}

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
      <button class="btn btn-primary" type="button" onclick="openTestModal('notify')">üîî Notifier test de fran√ßais</button>
      <button class="btn btn-outline" type="button" onclick="openTestModal('relance')">üîÅ Relancer test de fran√ßais</button>
    </div>

    <div style="margin-top:10px;">
  <label style="display:flex;align-items:center;gap:10px;font-weight:900;">
    <input id="chkTestFrValidated" type="checkbox" {% if (trainee.test_fr_status or "soon")=="validated" %}checked{% endif %}>
    Test valid√©
  </label>
  <div class="hint" style="margin-top:6px;">Si coch√©, le statut passe √† ‚ÄúVALID√â‚Äù.</div>
</div>

    
    {% if trainee.test_fr_last_notified_at %}
      <div class="hint" style="margin-top:10px;">üüß Notifi√© le : <strong>{{ trainee.test_fr_last_notified_at }}</strong></div>
    {% endif %}
    {% if trainee.test_fr_last_relance_at %}
      <div class="hint">üüß Relanc√© le : <strong>{{ trainee.test_fr_last_relance_at }}</strong></div>
    {% endif %}
  </div>

  <!-- ===================== -->
<!-- CONVENTION            -->
<!-- ===================== -->
<div class="card">
  <div class="card-head">
    <div>Convention</div>

    {% set cs = (trainee.convention_status or "soon") %}
    {% set cs_label = (
      "PROCHAINEMENT" if cs=="soon"
      else ("EN COURS DE SIGNATURE" if cs=="signing" else "SIGN√âE")
    ) %}

    <span class="pill
      {% if cs=="soon" %}pill-gray
      {% elif cs=="signing" %}pill-orange
      {% else %}pill-green
      {% endif %}">
      {{ cs_label }}
    </span>
  </div>

  <div class="hint" style="margin-bottom:8px;">
    Avancement de la convention de formation.
  </div>

  <select id="conventionSelect" class="status-pill">
    <option value="soon" {% if cs=="soon" %}selected{% endif %}>
      PROCHAINEMENT
    </option>
    <option value="signing" {% if cs=="signing" %}selected{% endif %}>
      EN COURS DE SIGNATURE
    </option>
    <option value="signed" {% if cs=="signed" %}selected{% endif %}>
      SIGN√âE
    </option>
  </select>
</div>



  <!-- ===================== -->
  <!-- DOCUMENTS              -->
  <!-- ===================== -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:900;">Gestion des documents</div>

      {% set dossier_label = ("DOSSIER COMPLET" if dossier_is_complete else "DOSSIER INCOMPLET") %}
      <span class="pill {% if dossier_is_complete %}pill-green{% else %}pill-red{% endif %}">
        {{ dossier_label }}
      </span>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
      <form method="post" action="{{ url_for('admin_docs_notify', session_id=session.id, trainee_id=trainee.id) }}">
        <button class="btn btn-primary" type="submit">üì© Notifier envoi documents</button>
      </form>

      <form method="post" action="{{ url_for('admin_docs_nonconform_notify', session_id=session.id, trainee_id=trainee.id) }}">
        <button class="btn btn-outline" type="submit">‚ö†Ô∏è Notifier documents non conformes</button>
      </form>

      <form method="post" action="{{ url_for('admin_docs_relance', session_id=session.id, trainee_id=trainee.id) }}">
        <button class="btn btn-outline" type="submit">üîÅ Relance stagiaire</button>
      </form>

      <a class="btn btn-outline"
         href="{{ url_for('admin_docs_zip', session_id=session.id, trainee_id=trainee.id) }}">
        ‚¨áÔ∏è T√©l√©charger les documents (ZIP)
      </a>
    </div>

    {% if trainee.docs_notified_at %}
      <div class="hint" style="margin-top:10px;">üüß Stagiaire notifi√© le : <strong>{{ trainee.docs_notified_at }}</strong></div>
    {% endif %}
    {% if trainee.docs_last_nonconform_notified_at %}
      <div class="hint">üüß Docs non conformes notifi√©s le : <strong>{{ trainee.docs_last_nonconform_notified_at }}</strong></div>
    {% endif %}
    {% if trainee.docs_last_relance_at %}
      <div class="hint">üüß Stagiaire relanc√© le : <strong>{{ trainee.docs_last_relance_at }}</strong></div>
    {% endif %}

    <div class="table-wrap" style="margin-top:10px;">
      <table class="table" id="docsTable" data-session-id="{{ session.id }}" data-trainee-id="{{ trainee.id }}">
        <thead>
          <tr>
            <th>Document</th>
            <th>Statut</th>
            <th>Commentaire</th>
            <th>Fichier</th>
          </tr>
        </thead>
        <tbody>
          {% for d in (trainee.documents or []) %}
          {% set has_file = (d.file and d.file|length > 0) %}
          {% set cur = (d.status or ("A CONTR√îLER" if has_file else "NON D√âPOS√â")) %}

          <tr data-doc-key="{{ d.key }}">
            <td style="font-weight:800;">{{ d.label }}</td>

            <td style="min-width:190px;">
              <select class="status sel-doc" data-field="status" {% if not has_file %}disabled{% endif %}>
                <option value="NON D√âPOS√â" {% if cur=="NON D√âPOS√â" %}selected{% endif %}>NON D√âPOS√â</option>
                <option value="A CONTR√îLER" {% if cur=="A CONTR√îLER" or cur=="A CONTROLER" %}selected{% endif %}>A CONTR√îLER</option>
                <option value="CONFORME" {% if cur=="CONFORME" %}selected{% endif %}>CONFORME</option>
                <option value="NON CONFORME" {% if cur=="NON CONFORME" %}selected{% endif %}>NON CONFORME</option>
              </select>

              <div class="hint" style="margin-top:6px;">
                {% if cur=="CONFORME" %}
                  <span class="pill pill-green">CONFORME</span>
                {% elif cur=="NON CONFORME" %}
                  <span class="pill pill-red">NON CONFORME</span>
                {% elif cur=="NON D√âPOS√â" %}
                  <span class="pill pill-gray">NON D√âPOS√â</span>
                {% else %}
                  <span class="pill pill-yellow">A CONTR√îLER</span>
                {% endif %}
              </div>

              {% if not has_file %}
                <div class="hint" style="margin-top:6px;">(statut activ√© d√®s qu‚Äôun fichier est d√©pos√©)</div>
              {% endif %}
            </td>

            <td>
              <input class="comment doc-comment" data-field="comment" value="{{ d.comment or "" }}" placeholder="Commentaire...">
            </td>

            <td class="mono" style="max-width:320px;">
              {% if has_file %}
                <a href="{{ url_for('admin_view_upload', path=d.file_token) }}" target="_blank">üìé Voir</a>
                <span class="hint" style="margin-left:8px;">(d√©j√† upload√©)</span>
              {% else %}
                <span class="hint">Aucun fichier</span>
              {% endif %}

              <form method="post" enctype="multipart/form-data"
                    action="{{ url_for('admin_upload_doc_file', session_id=session.id, trainee_id=trainee.id, doc_key=d.key) }}"
                    style="margin-top:6px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <input type="file" name="file" required>
                <button class="btn btn-outline" type="submit">‚¨ÜÔ∏è Uploader</button>
              </form>
            </td>

          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="hint" style="margin-top:8px;">Autosave actif (statut + commentaire).</div>
    </div>
  </div>

</div>



<!-- ===================== -->
<!-- VAE (DIRIGEANT VAE)    -->
<!-- ===================== -->
{% if show_vae %}
<div class="card" style="margin-top:12px;">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <div style="font-weight:900;">STATUT VAE</div>
    <span class="pill">{{ trainee.vae_status_label or "‚Äî" }}</span>
  </div>

  <div class="hint" style="margin-top:8px;">(Encadr√© pr√™t : tu pourras d√©clencher mails/SMS sur chaque √©tape ensuite.)</div>

  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
    {% for step in vae_steps %}
      <button class="btn btn-outline" type="button" onclick="setVaeStep('{{ step.key }}')">{{ step.label }}</button>
    {% endfor %}
  </div>
</div>
{% endif %}


<!-- ===================== -->
<!-- DIPL√îMES / ATTESTATIONS -->
<!-- ===================== -->
<div class="card" style="margin-top:12px;">
  <div style="font-weight:900;">Dipl√¥mes & attestations</div>
  <div class="hint" style="margin-top:6px;">Importer un fichier ‚Üí stockage + mail/SMS ‚Äúdisponible sur votre espace stagiaire‚Äù.</div>

  <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:10px;">
    <form method="post" enctype="multipart/form-data"
          action="{{ url_for('admin_upload_deliverable', session_id=session.id, trainee_id=trainee.id, kind='certificat_sst') }}">
      <input type="file" name="file" required>
      <button class="btn btn-primary" type="submit">‚¨ÜÔ∏è Importer certificat SST</button>
    </form>

    <form method="post" enctype="multipart/form-data"
          action="{{ url_for('admin_upload_deliverable', session_id=session.id, trainee_id=trainee.id, kind='diplome') }}">
      <input type="file" name="file" required>
      <button class="btn btn-primary" type="submit">‚¨ÜÔ∏è Importer dipl√¥me</button>
    </form>

    <form method="post" enctype="multipart/form-data"
          action="{{ url_for('admin_upload_deliverable', session_id=session.id, trainee_id=trainee.id, kind='attestation_fin_formation') }}">
      <input type="file" name="file" required>
      <button class="btn btn-primary" type="submit">‚¨ÜÔ∏è Importer attestation fin de formation</button>
    </form>

    <form method="post" enctype="multipart/form-data"
          action="{{ url_for('admin_upload_deliverable', session_id=session.id, trainee_id=trainee.id, kind='carte_sst') }}">
      <input type="file" name="file" required>
      <button class="btn btn-primary" type="submit">‚¨ÜÔ∏è Importer carte SST</button>
    </form>

    <form method="post" enctype="multipart/form-data"
          action="{{ url_for('admin_upload_deliverable', session_id=session.id, trainee_id=trainee.id, kind='dossier_fin_formation') }}">
      <input type="file" name="file" required>
      <button class="btn btn-primary" type="submit">‚¨ÜÔ∏è Importer dossier fin de formation</button>
    </form>
  </div>

  <div class="table-wrap" style="margin-top:10px;">
    <table class="table">
      <thead>
        <tr><th>√âl√©ment</th><th>Statut</th><th>Fichier</th></tr>
      </thead>
      <tbody>
        {% for item in deliverables_view %}
        <tr>
          <td style="font-weight:800;">{{ item.label }}</td>
          <td>{% if item.file %}<span class="pill pill-green">Import√©</span>{% else %}‚Äî{% endif %}</td>
          <td class="mono">
            {% if item.file %}
              <a href="{{ url_for('admin_view_upload', path=item.file_token) }}" target="_blank">üìé Voir</a>
            {% else %}
              ‚Äî
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>


<!-- ===================== -->
<!-- MODALE Test FR         -->
<!-- ===================== -->
<div class="modal-backdrop" id="testModal" aria-hidden="true">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title" id="testModalTitle">Test de fran√ßais</div>
      <button class="icon-btn" data-close-modal="testModal">‚úï</button>
    </div>

    <form method="post" id="testForm">
      <div class="modal-body">
        <div class="form-grid">
          <label>
            <div class="label">Code (nouveau √† chaque envoi)</div>
            <input name="code" type="text" required placeholder="ex : B1-29384">
          </label>
          <label>
            <div class="label">Date + heure max</div>
            <input name="deadline" type="text" required placeholder="ex : 02/03/2026 18:00">
          </label>
        </div>
        <div class="hint" style="margin-top:8px;">
          Un mail + SMS seront envoy√©s (si email/tel renseign√©s).
        </div>
      </div>

      <div class="modal-foot">
        <button class="btn" type="button" data-close-modal="testModal">Annuler</button>
        <button class="btn btn-primary" type="submit">Envoyer</button>
      </div>
    </form>
  </div>
</div>


<script>

  function toClassSafe(s){
  return (s || "").toString().trim().toLowerCase().replace(/\s+/g,"_");
}

function applyStatusPill(selectEl){
  if(!selectEl) return;
  selectEl.classList.add("status-pill");

  [...selectEl.classList].forEach(c=>{
    if(c.startsWith("is-")) selectEl.classList.remove(c);
  });

  const v = toClassSafe(selectEl.value);
  if(v) selectEl.classList.add("is-" + v);
  else selectEl.classList.add("is-soon");
}

  // util modal (si ton base.html fournit d√©j√† openModal/closeModal, √ßa marchera aussi)
  function openModal(id){ document.getElementById(id).setAttribute("aria-hidden","false"); document.getElementById(id).classList.add("show"); }
  function closeModal(id){ document.getElementById(id).setAttribute("aria-hidden","true"); document.getElementById(id).classList.remove("show"); }

  document.querySelectorAll("[data-close-modal]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const id = b.getAttribute("data-close-modal");
      closeModal(id);
    });
  });

  // Test FR modal logic
  function openTestModal(mode){
    const title = document.getElementById("testModalTitle");
    const form = document.getElementById("testForm");
    if(mode === "notify"){
      title.textContent = "Notifier test de fran√ßais";
      form.action = "{{ url_for('admin_test_fr_notify', session_id=session.id, trainee_id=trainee.id) }}";
    }else{
      title.textContent = "Relancer test de fran√ßais";
      form.action = "{{ url_for('admin_test_fr_relance', session_id=session.id, trainee_id=trainee.id) }}";
    }
    openModal("testModal");
  }

  // Autosave documents
  const docsTable = document.getElementById("docsTable");
  if(docsTable){
    const sessionId = docsTable.getAttribute("data-session-id");
    const traineeId = docsTable.getAttribute("data-trainee-id");

    async function saveDoc(key, field, value){
      await fetch(`/api/sessions/${sessionId}/stagiaires/${traineeId}/documents/update`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ key, field, value })
      });
    }

    // select changes
    docsTable.querySelectorAll("tr[data-doc-key]").forEach(tr=>{
      const key = tr.getAttribute("data-doc-key");

      const sel = tr.querySelector("select.sel-doc");
      if(sel){
        sel.addEventListener("change", async ()=>{
          await saveDoc(key, "status", sel.value);
          window.location.reload(); // pour recalcul dossier complet/incomplet
        });
      }

      // comment debounce
      const input = tr.querySelector("input.doc-comment");
      if(input){
        let t=null;
        input.addEventListener("input", ()=>{
          if(t) clearTimeout(t);
          t=setTimeout(async ()=>{
            await saveDoc(key, "comment", input.value);
          }, 450);
        });
      }
    });
  }

  // Refresh CNAPS
  async function cnapsLookup(nom, prenom){
    const r = await fetch(`/api/cnaps_lookup?nom=${encodeURIComponent(nom)}&prenom=${encodeURIComponent(prenom)}`);
    return await r.json();
  }

  document.getElementById("btnRefreshCnaps")?.addEventListener("click", async ()=>{
    const nom = ("{{ trainee.last_name|e }}").trim();
    const prenom = ("{{ trainee.first_name|e }}").trim();
    if(!nom || !prenom){ alert("Nom / pr√©nom introuvables"); return; }

    try{
      const res = await cnapsLookup(nom, prenom);
      const statut = (res.statut_cnaps || "INCONNU").toUpperCase();

      await fetch(`/api/sessions/{{ session.id }}/stagiaires/{{ trainee.id }}/update`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ cnaps: statut })
      });

      window.location.reload();
    }catch(e){
      alert("Erreur CNAPS");
    }
  });

  // VAE (simple update)
  async function setVaeStep(stepKey){
    await fetch(`/api/sessions/{{ session.id }}/stagiaires/{{ trainee.id }}/update`, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ vae_status_label: stepKey })
    });
    window.location.reload();
  }

    // ‚úÖ Checkbox "Test valid√©" -> test_fr_status = validated / in_progress
  const chk = document.getElementById("chkTestFrValidated");
  if(chk){
    chk.addEventListener("change", async ()=>{
      const newVal = chk.checked ? "validated" : "in_progress";

      try{
        await fetch(`/api/sessions/{{ session.id }}/stagiaires/{{ trainee.id }}/update`, {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ test_fr_status: newVal })
        });
        window.location.reload();
      }catch(e){
        alert("Erreur sauvegarde test de fran√ßais");
      }
    });
  }

  // =========================
// Convention status update
// =========================

const conventionSelect = document.getElementById("conventionSelect");

if(conventionSelect){
  applyStatusPill(conventionSelect); // ‚úÖ couleur au chargement

  conventionSelect.addEventListener("change", async ()=>{
    applyStatusPill(conventionSelect); // ‚úÖ couleur imm√©diate

    const value = conventionSelect.value;

    try{
      await fetch(`/api/sessions/{{ session.id }}/stagiaires/{{ trainee.id }}/update`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ convention_status: value })
      });
      window.location.reload();
    }catch(e){
      alert("Erreur sauvegarde convention");
    }
  });
}

  

</script>

{% endblock %}
