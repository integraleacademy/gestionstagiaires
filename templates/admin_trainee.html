{% extends "base.html" %}
{% block content %}

<div class="breadcrumbs">
  <a href="{{ url_for('admin_trainees', session_id=session.id, **request.args) }}">â† Retour stagiaires</a>
</div>

<div class="session-header">
  <div>
    <h1>Fiche stagiaire</h1>

    <div class="meta-line">
      <span class="pill">{{ session.training_type }}</span>
      <span>Session : <strong>{{ session.name }}</strong></span>
      <span>Formation : <strong>{{ session.date_start|frdate }}</strong> â†’ <strong>{{ session.date_end|frdate }}</strong></span>
      <span>Examen : <strong>{{ session.exam_date|frdate }}</strong></span>

    </div>
  </div>
</div>

<div class="card" style="margin-top:12px;">
  <!-- LIGNE 1 : NOM + PHOTO CÃ”TE Ã€ CÃ”TE -->
  <div style="display:flex;gap:14px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;">
    <div style="flex:1;min-width:320px;">

<div style="display:flex;gap:10px;align-items:flex-start;flex-wrap:nowrap;">

  <!-- PHOTO Ã€ GAUCHE -->
  <div style="width:110px;flex-shrink:0;">
    {% if trainee.identity_photo %}
      <img
        src="{{ url_for('admin_view_upload', path=trainee.identity_photo) }}"
        alt="Photo d'identitÃ©"
        style="width:110px;height:140px;object-fit:cover;border-radius:12px;border:1px solid #e5e7eb;background:#fff;"
      />
    {% else %}
      <div style="width:110px;height:140px;border-radius:12px;border:1px dashed #cbd5e1;background:#f8fafc;display:flex;align-items:center;justify-content:center;font-size:12px;color:#64748b;text-align:center;">
        Aucune photo
      </div>
    {% endif %}
  </div>

  <!-- NOM / PRÃ‰NOM Ã€ DROITE -->
<div style="font-size:20px;font-weight:900;line-height:1.1;margin-top:2px;">
    {{ trainee.first_name }} {{ trainee.last_name }}
  </div>

  <!-- UPLOAD Ã€ CÃ”TÃ‰ -->
  <div style="display:flex;flex-direction:column;gap:6px;">
    <form id="photoForm" method="post" enctype="multipart/form-data"
          action="{{ url_for('admin_upload_identity_photo', session_id=session.id, trainee_id=trainee.id) }}">
      <input id="photoInput" type="file" name="file" accept="image/*" required style="display:none;">
      <label for="photoInput" class="btn btn-outline" style="padding:8px 10px;cursor:pointer;white-space:nowrap;">
        ğŸªª Importer photo
      </label>
    </form>
    <div class="hint">(upload immÃ©diat)</div>
  </div>

</div>

      <div class="meta-line" style="margin-top:10px;">
        <span class="mono">Email : {{ trainee.email or "â€”" }}</span>
        <span class="mono">Tel : {{ trainee.phone or "â€”" }}</span>
        <span class="mono">ID : {{ trainee.personal_id or trainee.id }}</span>
      </div>

      <div class="meta-line" style="margin-top:8px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
        {% set c = (trainee.cnaps or "INCONNU")|upper %}
        <span class="cnaps
          {% if "TRANSM" in c %}cnaps-transmis
          {% elif "ENREG" in c %}cnaps-enregistre
          {% elif "INSTRU" in c %}cnaps-instruction
          {% elif "ACCEPT" in c %}cnaps-accepte
          {% elif "REFUS" in c %}cnaps-refuse
          {% elif "DOC" in c %}cnaps-docs
          {% else %}cnaps-inconnu
          {% endif %}">
          CNAPS : {{ c }}
        </span>

        <button class="mini-btn" id="btnRefreshCnaps" type="button">â†» RafraÃ®chir CNAPS</button>

        {% if trainee.access_sent_at %}
          <span class="hint">âœ… AccÃ¨s envoyÃ© le : <strong>{{ trainee.access_sent_at }}</strong></span>
        {% endif %}
      </div>
    </div>

    <!-- BOUTONS ACTIONS Ã€ DROITE -->
    <div class="btn-row" style="justify-content:flex-end;">
      <form method="post" action="{{ url_for('admin_delete_trainee', session_id=session.id, trainee_id=trainee.id) }}"
            onsubmit="return confirm('Supprimer ce stagiaire ?');">
<button class="btn btn-danger btn-uniform" type="submit">
  ğŸ—‘ï¸ Supprimer le stagiaire
</button>
      </form>

<a class="btn btn-outline btn-uniform"
   href="{{ url_for('admin_etiquette_docx', session_id=session.id, trainee_id=trainee.id) }}">
  ğŸ–¨ï¸ Imprimer Ã©tiquette dossier (Word)
</a>

      <form method="post" action="{{ url_for('admin_send_access', session_id=session.id, trainee_id=trainee.id) }}">
<button class="btn btn-primary btn-uniform" type="submit">
  ğŸ“© Envoyer accÃ¨s espace stagiaire
</button>
      </form>

<a class="btn btn-outline btn-uniform"
   href="{{ PUBLIC_STUDENT_PORTAL_BASE.rstrip('/') }}/espace/{{ trainee.public_token }}"
   target="_blank" rel="noopener">
  ğŸ‘ï¸ Voir espace stagiaire (public)
</a>
    </div>
  </div>
</div>

<script>
  document.getElementById("photoInput")?.addEventListener("change", function(){
    if(this.files && this.files.length > 0){
      document.getElementById("photoForm")?.submit();
    }
  });
</script>


<div class="grid trainee-grid two-cols" style="gap:12px;margin-top:12px;">

  <!-- ===================== -->
  <!-- TEST DE FRANÃ‡AIS       -->
  <!-- ===================== -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:900;">Test de franÃ§ais</div>
      <div>
        {% set tf = (trainee.test_fr_status or "soon") %}
        {% set tf_label = ("PROCHAINEMENT" if tf=="soon" else ("EN COURS" if tf=="in_progress" else ("RELANCÃ‰" if tf=="relance" else "VALIDÃ‰"))) %}
        <span class="pill
          {% if tf=="soon" %}pill-gray
          {% elif tf=="in_progress" %}pill-orange
          {% elif tf=="relance" %}pill-red
          {% else %}pill-green
          {% endif %}">
          Statut : {{ tf_label }}
        </span>
      </div>
    </div>

    <div class="hint" style="margin-top:8px;">
      Lien : <a href="https://testb1.lapreventionsecurite.org/Public/" target="_blank">https://testb1.lapreventionsecurite.org/Public/</a>
    </div>

    {% if trainee.test_fr_deadline %}
      <div class="hint" style="margin-top:6px;">Ã‰chÃ©ance : <strong>{{ trainee.test_fr_deadline }}</strong></div>
    {% endif %}

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
      <button class="btn btn-primary" type="button" onclick="openTestModal('notify')">ğŸ”” Notifier test de franÃ§ais</button>
      <button class="btn btn-outline" type="button" onclick="openTestModal('relance')">ğŸ” Relancer test de franÃ§ais</button>
    </div>

<div style="margin-top:10px;">
  <div class="chk-inline">
    <input
      id="chkTestFrValidated"
      type="checkbox"
      {% if (trainee.test_fr_status or "soon")=="validated" %}checked{% endif %}
    >
    <label for="chkTestFrValidated" style="cursor:pointer;">Test validÃ©</label>
  </div>

  <div class="hint" style="margin-top:6px;">
    Si cochÃ©, le statut passe Ã  â€œVALIDÃ‰â€.
  </div>
</div>

<div class="hint" style="margin-top:6px;">
  Si cochÃ©, le statut passe Ã  â€œVALIDÃ‰â€.
</div>

    {% if trainee.test_fr_last_notified_at %}
      <div class="hint" style="margin-top:10px;">ğŸŸ§ NotifiÃ© le : <strong>{{ trainee.test_fr_last_notified_at }}</strong></div>
    {% endif %}
    {% if trainee.test_fr_last_relance_at %}
      <div class="hint">ğŸŸ§ RelancÃ© le : <strong>{{ trainee.test_fr_last_relance_at }}</strong></div>
    {% endif %}
  </div>

  <!-- ===================== -->
  <!-- CONVENTION & FINANCEMENT -->
  <!-- ===================== -->
  <div class="card">
    <div class="card-head">
      <div>Convention & Financement</div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">

      <!-- CONVENTION -->
      <div>
        <div style="font-weight:900;margin-bottom:6px;">Convention</div>
        {% set cs = (trainee.convention_status or "soon") %}
        <select id="conventionSelect" class="status-pill" style="margin-top:8px;">
          <option value="soon" {% if cs=="soon" %}selected{% endif %}>PROCHAINEMENT</option>
          <option value="signing" {% if cs=="signing" %}selected{% endif %}>EN COURS DE SIGNATURE</option>
          <option value="signed" {% if cs=="signed" %}selected{% endif %}>SIGNÃ‰E</option>
        </select>
      </div>

      <!-- FINANCEMENT -->
      <div>
        <div style="font-weight:900;margin-bottom:6px;">Financement</div>
        {% set fs = (trainee.financement_status or "soon") %}
        <select id="financementSelect" class="status-pill" style="margin-top:8px;">
          <option value="soon" {% if fs=="soon" %}selected{% endif %}>PROCHAINEMENT</option>
          <option value="in_review" {% if fs=="in_review" %}selected{% endif %}>EN COURS DE VALIDATION</option>
          <option value="validated" {% if fs=="validated" %}selected{% endif %}>VALIDÃ‰</option>
        </select>
      </div>

      <!-- COMMENTAIRE FINANCEMENT (pleine largeur dans la carte) -->
      <div style="margin-top:10px;grid-column:1 / -1;">
        <div class="label">Commentaire financement</div>
        <input id="financementComment"
               type="text"
               value="{{ trainee.financement_comment or '' }}"
               placeholder="Ex : France Travail en attente / OPCO validÃ© / CPFâ€¦">
        <div class="hint">Sauvegarde automatique.</div>
      </div>

    </div>
  </div>

  <!-- ===================== -->
  <!-- DOCUMENTS (pleine largeur) -->
  <!-- ===================== -->
  <div class="card" style="grid-column:1 / -1;">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:900;">Gestion des documents</div>

      {% set dossier_label = ("DOSSIER COMPLET" if dossier_is_complete else "DOSSIER INCOMPLET") %}
      <span class="pill {% if dossier_is_complete %}pill-green{% else %}pill-red{% endif %}">
        {{ dossier_label }}
      </span>
    </div>

      <!-- Permis requis / non requis -->
  <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
    {% if trainee.no_permis %}
      <span class="pill pill-gray">ğŸš« Permis non requis</span>
    {% else %}
      <span class="pill pill-yellow">ğŸªª Permis requis</span>
    {% endif %}
  </div>

   <div class="btn-row" style="margin-top:10px;">
  <form method="post" action="{{ url_for('admin_docs_notify', session_id=session.id, trainee_id=trainee.id) }}">
    <button class="btn btn-primary btn-uniform" type="submit">ğŸ“© Notifier envoi documents</button>
  </form>

  <form method="post" action="{{ url_for('admin_docs_nonconform_notify', session_id=session.id, trainee_id=trainee.id) }}">
    <button class="btn btn-outline btn-uniform" type="submit">âš ï¸ Notifier documents non conformes</button>
  </form>

  <form method="post" action="{{ url_for('admin_docs_relance', session_id=session.id, trainee_id=trainee.id) }}">
    <button class="btn btn-outline btn-uniform" type="submit">ğŸ” Relance stagiaire</button>
  </form>

  <a class="btn btn-outline btn-uniform"
     href="{{ url_for('admin_docs_zip', session_id=session.id, trainee_id=trainee.id) }}">
    â¬‡ï¸ TÃ©lÃ©charger les documents (ZIP)
  </a>
</div>

    {% if trainee.docs_notified_at %}
      <div class="hint" style="margin-top:10px;">ğŸŸ§ Stagiaire notifiÃ© le : <strong>{{ trainee.docs_notified_at }}</strong></div>
    {% endif %}
    {% if trainee.docs_last_nonconform_notified_at %}
      <div class="hint">ğŸŸ§ Docs non conformes notifiÃ©s le : <strong>{{ trainee.docs_last_nonconform_notified_at }}</strong></div>
    {% endif %}
    {% if trainee.docs_last_relance_at %}
      <div class="hint">ğŸŸ§ Stagiaire relancÃ© le : <strong>{{ trainee.docs_last_relance_at }}</strong></div>
    {% endif %}

    <div class="table-wrap" style="margin-top:10px;">
      <table class="table" id="docsTable" data-session-id="{{ session.id }}" data-trainee-id="{{ trainee.id }}">
        <thead>
          <tr>
            <th>Document</th>
            <th>Statut</th>
            <th>Commentaire</th>
            <th>Fichier</th>
          </tr>
        </thead>
        <tbody>
          {% for d in (trainee.documents or []) %}
          {% set has_file = (d.file and d.file|length > 0) %}
          {% set cur = (d.status or ("A CONTRÃ”LER" if has_file else "NON DÃ‰POSÃ‰")) %}

          <tr data-doc-key="{{ d.key }}">
            <td style="font-weight:800;">{{ d.label }}</td>

            <td style="min-width:190px;">
              <select class="status sel-doc" data-field="status" {% if not has_file %}disabled{% endif %}>
                <option value="NON DÃ‰POSÃ‰" {% if cur=="NON DÃ‰POSÃ‰" %}selected{% endif %}>NON DÃ‰POSÃ‰</option>
                <option value="A CONTRÃ”LER" {% if cur=="A CONTRÃ”LER" or cur=="A CONTROLER" %}selected{% endif %}>A CONTRÃ”LER</option>
                <option value="CONFORME" {% if cur=="CONFORME" %}selected{% endif %}>CONFORME</option>
                <option value="NON CONFORME" {% if cur=="NON CONFORME" %}selected{% endif %}>NON CONFORME</option>
              </select>

              <div class="hint" style="margin-top:6px;">
                {% if cur=="CONFORME" %}
                  <span class="pill pill-green">CONFORME</span>
                {% elif cur=="NON CONFORME" %}
                  <span class="pill pill-red">NON CONFORME</span>
                {% elif cur=="NON DÃ‰POSÃ‰" %}
                  <span class="pill pill-gray">NON DÃ‰POSÃ‰</span>
                {% else %}
                  <span class="pill pill-yellow">A CONTRÃ”LER</span>
                {% endif %}
              </div>

              {% if not has_file %}
                <div class="hint" style="margin-top:6px;">(statut activÃ© dÃ¨s quâ€™un fichier est dÃ©posÃ©)</div>
              {% endif %}
            </td>

            <td>
              <input class="comment doc-comment" data-field="comment" value="{{ d.comment or "" }}" placeholder="Commentaire...">
            </td>

            <td class="mono" style="max-width:320px;">
             {% if has_file %}
  <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
    <a href="{{ url_for('admin_view_upload', path=d.file_token) }}" target="_blank">ğŸ“ Voir</a>

    <form method="post"
          action="{{ url_for('admin_delete_doc_file', session_id=session.id, trainee_id=trainee.id, doc_key=d.key) }}"
          onsubmit="return confirm('Supprimer ce fichier ?');"
          style="display:inline;">
      <button class="btn btn-danger" type="submit" style="padding:6px 10px;">ğŸ—‘ï¸ Supprimer</button>
    </form>

    <span class="hint">(dÃ©jÃ  uploadÃ©)</span>
  </div>
{% else %}
  <span class="hint">Aucun fichier</span>
{% endif %}

  
            </td>

          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="hint" style="margin-top:8px;">Autosave actif (statut + commentaire).</div>
    </div>
  </div>

</div>



<!-- ===================== -->
<!-- VAE (DIRIGEANT VAE)    -->
<!-- ===================== -->
{% if show_vae %}
<div class="card" style="margin-top:12px;">
  <div style="display:flex;justify-content:space-between;align-items:center;">
    <div style="font-weight:900;">STATUT VAE</div>
    <span class="pill">{{ trainee.vae_status_label or "â€”" }}</span>
  </div>

  <div class="hint" style="margin-top:8px;">(EncadrÃ© prÃªt : tu pourras dÃ©clencher mails/SMS sur chaque Ã©tape ensuite.)</div>

  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
    {% for step in vae_steps %}
      <button class="btn btn-outline" type="button" onclick="setVaeStep('{{ step.key }}')">{{ step.label }}</button>
    {% endfor %}
  </div>
</div>
{% endif %}


<!-- ===================== -->
<!-- DIPLÃ”MES / ATTESTATIONS -->
<!-- ===================== -->
<div class="card" style="margin-top:12px;">
  <div style="font-weight:900;">DiplÃ´mes & attestations</div>
  <div class="hint" style="margin-top:6px;">Importer un fichier â†’ stockage + mail/SMS â€œdisponible sur votre espace stagiaireâ€.</div>

<form class="upload-form" method="post" enctype="multipart/form-data"
      action="{{ url_for('admin_upload_deliverable', session_id=session.id, trainee_id=trainee.id, kind='diplome') }}">
  <input type="file" name="file" required>
  <button class="btn btn-primary" type="submit">â¬†ï¸ Importer diplÃ´me</button>
</form>

<form class="upload-form" method="post" enctype="multipart/form-data"
      action="{{ url_for('admin_upload_deliverable', session_id=session.id, trainee_id=trainee.id, kind='attestation_fin_formation') }}">
  <input type="file" name="file" required>
  <button class="btn btn-primary" type="submit">â¬†ï¸ Importer attestation fin de formation</button>
</form>

<form class="upload-form" method="post" enctype="multipart/form-data"
      action="{{ url_for('admin_upload_deliverable', session_id=session.id, trainee_id=trainee.id, kind='carte_sst') }}">
  <input type="file" name="file" required>
  <button class="btn btn-primary" type="submit">â¬†ï¸ Importer carte SST</button>
</form>
  </div>

  <div class="table-wrap" style="margin-top:10px;">
    <table class="table">
      <thead>
        <tr><th>Ã‰lÃ©ment</th><th>Statut</th><th>Fichier</th></tr>
      </thead>
      <tbody>
        {% for item in deliverables_view %}
        <tr>
          <td style="font-weight:800;">{{ item.label }}</td>
          <td>{% if item.file %}<span class="pill pill-green">ImportÃ©</span>{% else %}â€”{% endif %}</td>
          <td class="mono">
            {% if item.file %}
              <a href="{{ url_for('admin_view_upload', path=item.file_token) }}" target="_blank">ğŸ“ Voir</a>
            {% else %}
              â€”
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>


<!-- ===================== -->
<!-- MODALE Test FR         -->
<!-- ===================== -->
<div class="modal-backdrop" id="testModal" aria-hidden="true">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title" id="testModalTitle">Test de franÃ§ais</div>
      <button class="icon-btn" data-close-modal="testModal">âœ•</button>
    </div>

    <form method="post" id="testForm">
      <div class="modal-body">
        <div class="form-grid">
          <label>
            <div class="label">Code (nouveau Ã  chaque envoi)</div>
            <input name="code" type="text" required placeholder="ex : B1-29384">
          </label>
          <label>
            <div class="label">Date + heure max</div>
            <input name="deadline" type="text" required placeholder="ex : 02/03/2026 18:00">
          </label>
        </div>
        <div class="hint" style="margin-top:8px;">
          Un mail + SMS seront envoyÃ©s (si email/tel renseignÃ©s).
        </div>
      </div>

      <div class="modal-foot">
        <button class="btn" type="button" data-close-modal="testModal">Annuler</button>
        <button class="btn btn-primary" type="submit">Envoyer</button>
      </div>
    </form>
  </div>
</div>


<script>

  // =========================
// Financement comment autosave
// =========================
const financementComment = document.getElementById("financementComment");
if(financementComment){
  let t=null;
  financementComment.addEventListener("input", ()=>{
    if(t) clearTimeout(t);
    t = setTimeout(async ()=>{
      try{
        await fetch(`/api/sessions/{{ session.id }}/stagiaires/{{ trainee.id }}/update`, {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ financement_comment: financementComment.value })
        });
      }catch(e){
        // pas de reload, on Ã©vite d'emmerder
        console.log("Erreur sauvegarde commentaire financement");
      }
    }, 450);
  });
}

  function toClassSafe(s){
  return (s || "").toString().trim().toLowerCase().replace(/\s+/g,"_");
}

function applyStatusPill(selectEl){
  if(!selectEl) return;
  selectEl.classList.add("status-pill");

  [...selectEl.classList].forEach(c=>{
    if(c.startsWith("is-")) selectEl.classList.remove(c);
  });

  const v = toClassSafe(selectEl.value);
  if(v) selectEl.classList.add("is-" + v);
  else selectEl.classList.add("is-soon");
}

  // util modal (si ton base.html fournit dÃ©jÃ  openModal/closeModal, Ã§a marchera aussi)
  function openModal(id){ document.getElementById(id).setAttribute("aria-hidden","false"); document.getElementById(id).classList.add("show"); }
  function closeModal(id){ document.getElementById(id).setAttribute("aria-hidden","true"); document.getElementById(id).classList.remove("show"); }

  document.querySelectorAll("[data-close-modal]").forEach(b=>{
    b.addEventListener("click", ()=>{
      const id = b.getAttribute("data-close-modal");
      closeModal(id);
    });
  });

  // Test FR modal logic
  function openTestModal(mode){
    const title = document.getElementById("testModalTitle");
    const form = document.getElementById("testForm");
    if(mode === "notify"){
      title.textContent = "Notifier test de franÃ§ais";
      form.action = "{{ url_for('admin_test_fr_notify', session_id=session.id, trainee_id=trainee.id) }}";
    }else{
      title.textContent = "Relancer test de franÃ§ais";
      form.action = "{{ url_for('admin_test_fr_relance', session_id=session.id, trainee_id=trainee.id) }}";
    }
    openModal("testModal");
  }

  // Autosave documents
  const docsTable = document.getElementById("docsTable");
  if(docsTable){
    const sessionId = docsTable.getAttribute("data-session-id");
    const traineeId = docsTable.getAttribute("data-trainee-id");

    async function saveDoc(key, field, value){
      await fetch(`/api/sessions/${sessionId}/stagiaires/${traineeId}/documents/update`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ key, field, value })
      });
    }

    // select changes
    docsTable.querySelectorAll("tr[data-doc-key]").forEach(tr=>{
      const key = tr.getAttribute("data-doc-key");

      const sel = tr.querySelector("select.sel-doc");
      if(sel){
        sel.addEventListener("change", async ()=>{
          await saveDoc(key, "status", sel.value);
          window.location.reload(); // pour recalcul dossier complet/incomplet
        });
      }

      // comment debounce
      const input = tr.querySelector("input.doc-comment");
      if(input){
        let t=null;
        input.addEventListener("input", ()=>{
          if(t) clearTimeout(t);
          t=setTimeout(async ()=>{
            await saveDoc(key, "comment", input.value);
          }, 450);
        });
      }
    });
  }

  // Refresh CNAPS
  async function cnapsLookup(nom, prenom){
    const r = await fetch(`/api/cnaps_lookup?nom=${encodeURIComponent(nom)}&prenom=${encodeURIComponent(prenom)}`);
    return await r.json();
  }

  document.getElementById("btnRefreshCnaps")?.addEventListener("click", async ()=>{
    const nom = ("{{ trainee.last_name|e }}").trim();
    const prenom = ("{{ trainee.first_name|e }}").trim();
    if(!nom || !prenom){ alert("Nom / prÃ©nom introuvables"); return; }

    try{
      const res = await cnapsLookup(nom, prenom);
      const statut = (res.statut_cnaps || "INCONNU").toUpperCase();

      await fetch(`/api/sessions/{{ session.id }}/stagiaires/{{ trainee.id }}/update`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ cnaps: statut })
      });

      window.location.reload();
    }catch(e){
      alert("Erreur CNAPS");
    }
  });

  // VAE (simple update)
  async function setVaeStep(stepKey){
    await fetch(`/api/sessions/{{ session.id }}/stagiaires/{{ trainee.id }}/update`, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ vae_status_label: stepKey })
    });
    window.location.reload();
  }

    // âœ… Checkbox "Test validÃ©" -> test_fr_status = validated / in_progress
  const chk = document.getElementById("chkTestFrValidated");
  if(chk){
    chk.addEventListener("change", async ()=>{
      const newVal = chk.checked ? "validated" : "in_progress";

      try{
        await fetch(`/api/sessions/{{ session.id }}/stagiaires/{{ trainee.id }}/update`, {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ test_fr_status: newVal })
        });
        window.location.reload();
      }catch(e){
        alert("Erreur sauvegarde test de franÃ§ais");
      }
    });
  }

  // =========================
// Convention status update
// =========================

const conventionSelect = document.getElementById("conventionSelect");

if(conventionSelect){
  applyStatusPill(conventionSelect); // âœ… couleur au chargement

  conventionSelect.addEventListener("change", async ()=>{
    applyStatusPill(conventionSelect); // âœ… couleur immÃ©diate

    const value = conventionSelect.value;

    try{
      await fetch(`/api/sessions/{{ session.id }}/stagiaires/{{ trainee.id }}/update`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ convention_status: value })
      });
      window.location.reload();
    }catch(e){
      alert("Erreur sauvegarde convention");
    }
  });
}

// =========================
// Financement status update
// =========================
const financementSelect = document.getElementById("financementSelect");

if(financementSelect){
  applyStatusPill(financementSelect); // âœ… couleur au chargement

  financementSelect.addEventListener("change", async ()=>{
    applyStatusPill(financementSelect); // âœ… couleur immÃ©diate

    const value = financementSelect.value;

    try{
      await fetch(`/api/sessions/{{ session.id }}/stagiaires/{{ trainee.id }}/update`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ financement_status: value })
      });
      window.location.reload();
    }catch(e){
      alert("Erreur sauvegarde financement");
    }
  });
}
  

  

</script>

{% endblock %}
